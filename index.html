<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PalabraRogue</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #1a1f2e;
            --surface: #242b3d;
            --surface2: #2e3750;
            --border: rgba(255,255,255,0.14);
            --gold: #e8c46a;
            --gold-light: #f5d98a;
            --gold-dim: rgba(232,196,106,0.18);
            --red: #f07070;
            --green: #6ed49a;
            --blue: #70aaf0;
            --text: #f0eadc;
            --text-muted: #a09880;
            --text-dim: #706858;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(ellipse 60% 40% at 20% 10%, rgba(201,168,76,0.04) 0%, transparent 60%),
                radial-gradient(ellipse 50% 30% at 80% 80%, rgba(82,148,224,0.04) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        /* ---- SCREENS ---- */
        .screen { display: none; width: 100%; max-width: 900px; padding: 20px; position: relative; z-index: 1; }
        .screen.active { display: flex; flex-direction: column; align-items: center; }

        /* ---- START SCREEN ---- */
        #screen-start {
            min-height: 100vh;
            justify-content: center;
            gap: 40px;
        }

        .logo {
            text-align: center;
        }

        .logo-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(48px, 8vw, 90px);
            font-weight: 900;
            color: var(--gold);
            letter-spacing: -2px;
            line-height: 1;
            text-shadow: 0 0 60px rgba(201,168,76,0.3);
        }

        .logo-sub {
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            letter-spacing: 6px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 10px;
        }

        .start-btn {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 700;
            background: var(--gold);
            color: #0d0f14;
            border: none;
            padding: 16px 48px;
            border-radius: 4px;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .start-btn:hover {
            background: var(--gold-light);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(201,168,76,0.3);
        }

        .start-info {
            font-size: 13px;
            color: var(--text-muted);
            text-align: center;
            line-height: 1.8;
        }

        /* ---- HUD ---- */
        #screen-game { padding-top: 0; gap: 0; }

        .hud {
            width: 100%;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 24px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .hud-section {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .hud-label {
            font-family: 'DM Mono', monospace;
            font-size: 9px;
            letter-spacing: 3px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .hud-value {
            font-family: 'Playfair Display', serif;
            font-size: 26px;
            font-weight: 700;
            color: var(--gold);
            line-height: 1;
        }

        .hud-value.red { color: var(--red); }
        .hud-value.green { color: var(--green); }

        .hud-sep { width: 1px; height: 36px; background: var(--border); margin: 0 4px; }

        .hud-progress {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .hud-progress-labels {
            display: flex;
            justify-content: space-between;
            font-family: 'DM Mono', monospace;
            font-size: 10px;
            color: var(--text-muted);
        }

        .progress-bar-outer {
            height: 6px;
            background: var(--surface2);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--gold-light));
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .hud-round {
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
            text-align: right;
            white-space: nowrap;
        }

        /* ---- GAME BODY ---- */
        .game-body {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 20px;
            gap: 20px;
        }

        /* ---- WORD DISPLAY ---- */
        .word-area {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            min-height: 120px;
            justify-content: center;
        }

        .word-display {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
            min-height: 60px;
            align-items: center;
        }

        .word-letter {
            font-family: 'Playfair Display', serif;
            font-size: 42px;
            font-weight: 900;
            color: var(--gold);
            background: var(--gold-dim);
            border: 1px solid rgba(232,196,106,0.3);
            width: 60px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            animation: letterPop 0.15s ease;
            position: relative;
        }

        .word-letter .letter-val {
            position: absolute;
            bottom: 3px;
            right: 5px;
            font-family: 'DM Mono', monospace;
            font-size: 9px;
            color: var(--gold);
            opacity: 0.7;
        }

        @keyframes letterPop {
            0% { transform: scale(0.7); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .word-score-preview {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--gold);
            height: 34px;
            transition: all 0.2s;
            letter-spacing: 1px;
        }

        .word-score-preview .preview-detail {
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 400;
            margin-left: 6px;
            letter-spacing: 2px;
        }
            font-size: 12px;
            letter-spacing: 4px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .word-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            letter-spacing: 2px;
            text-transform: uppercase;
            padding: 8px 18px;
            border-radius: 6px;
            border: 1px solid;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .btn-play {
            background: var(--gold);
            color: #0d0f14;
            border-color: var(--gold);
            font-weight: 500;
        }
        .btn-play:hover:not(:disabled) {
            background: var(--gold-light);
            box-shadow: 0 4px 20px rgba(201,168,76,0.3);
        }

        .btn-clear {
            background: transparent;
            color: var(--text-muted);
            border-color: var(--border);
        }
        .btn-clear:hover:not(:disabled) {
            border-color: var(--red);
            color: var(--red);
        }

        /* ---- FEEDBACK ---- */
        .feedback {
            font-family: 'DM Mono', monospace;
            font-size: 15px;
            letter-spacing: 2px;
            height: 22px;
            text-align: center;
            transition: all 0.3s;
        }
        .feedback.ok { color: var(--green); }
        .feedback.err { color: var(--red); }

        /* ---- HAND ---- */
        .hand-section {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 14px;
        }

        .hand-label {
            font-family: 'DM Mono', monospace;
            font-size: 10px;
            letter-spacing: 4px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .hand {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tile {
            font-family: 'Playfair Display', serif;
            font-size: 34px;
            font-weight: 900;
            width: 76px;
            height: 90px;
            background: var(--surface2);
            border: 2px solid var(--border);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            user-select: none;
            color: var(--text);
        }

        .tile .tile-val {
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 400;
            margin-top: 2px;
        }

        .tile:hover:not(.selected):not(.discarding):not(.empty) {
            border-color: rgba(201,168,76,0.5);
            background: rgba(201,168,76,0.05);
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .tile.selected {
            border-color: var(--gold);
            background: var(--gold-dim);
            color: var(--gold);
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(201,168,76,0.2);
        }

        .tile.empty {
            opacity: 0.2;
            cursor: default;
            border-style: dashed;
        }

        .tile.discarding {
            border-color: var(--red);
            background: rgba(224,82,82,0.1);
            color: var(--red);
            cursor: pointer;
        }

        .tile.discarding:hover {
            background: rgba(224,82,82,0.2);
            transform: translateY(-4px);
        }

        /* ---- HAND CONTROLS ---- */
        .hand-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-hand {
            background: transparent;
            color: var(--text-muted);
            border-color: var(--border);
            font-size: 10px;
            padding: 6px 14px;
        }
        .btn-hand:hover:not(:disabled) {
            border-color: var(--text-muted);
            color: var(--text);
        }

        .btn-discard-mode {
            background: transparent;
            color: var(--red);
            border-color: rgba(224,82,82,0.3);
            font-size: 10px;
            padding: 6px 14px;
        }
        .btn-discard-mode:hover:not(:disabled) {
            background: rgba(224,82,82,0.1);
        }
        .btn-discard-mode.active {
            background: rgba(224,82,82,0.15);
            border-color: var(--red);
        }

        .counter-badge {
            font-family: 'DM Mono', monospace;
            font-size: 10px;
            color: var(--text-dim);
        }

        /* ---- BAG INFO ---- */
        .bag-info {
            font-family: 'DM Mono', monospace;
            font-size: 10px;
            color: var(--text-dim);
            letter-spacing: 2px;
        }

        /* ---- LOG ---- */
        .log {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 18px;
            max-height: 150px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .log::-webkit-scrollbar { width: 4px; }
        .log::-webkit-scrollbar-track { background: transparent; }
        .log::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .log-entry {
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
            display: flex;
            gap: 12px;
            align-items: baseline;
        }
        .log-entry.ok .log-word { color: var(--green); }
        .log-entry.err .log-word { color: var(--red); }
        .log-entry.sys { color: var(--text-dim); font-style: italic; }
        .log-word { color: var(--gold); font-weight: 500; letter-spacing: 2px; }
        .log-pts { color: var(--gold-light); }

        /* ---- MODALS ---- */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            max-width: 480px;
            width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            0% { transform: scale(0.9) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            font-weight: 900;
            color: var(--gold);
            text-align: center;
        }

        .modal-sub {
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            letter-spacing: 3px;
            color: var(--text-muted);
            text-align: center;
            text-transform: uppercase;
        }

        .modal-stat {
            display: flex;
            gap: 8px;
            align-items: baseline;
        }
        .modal-stat-label { font-size: 13px; color: var(--text-muted); }
        .modal-stat-val {
            font-family: 'Playfair Display', serif;
            font-size: 32px;
            font-weight: 900;
            color: var(--gold);
        }

        /* SHOP */
        .shop-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
        }

        .shop-item {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .shop-item:hover:not(.cant-afford) {
            border-color: var(--gold);
            background: var(--gold-dim);
        }

        .shop-item.cant-afford { opacity: 0.4; cursor: not-allowed; }

        .shop-item-name {
            font-family: 'Playfair Display', serif;
            font-size: 15px;
            font-weight: 700;
            color: var(--text);
        }

        .shop-item-desc {
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .shop-item-price {
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            color: var(--gold);
            margin-top: 4px;
        }

        .coins-display {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--gold);
        }

        /* ---- BOSS INDICATOR ---- */
        .boss-indicator {
            font-family: 'DM Mono', monospace;
            font-size: 10px;
            letter-spacing: 3px;
            color: var(--red);
            text-transform: uppercase;
            padding: 4px 12px;
            border: 1px solid rgba(224,82,82,0.3);
            border-radius: 20px;
            background: rgba(224,82,82,0.05);
        }

        /* ---- GAME OVER / WIN ---- */
        .big-emoji {
            font-size: 56px;
            line-height: 1;
        }

        .result-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .result-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        .result-stat-row span:last-child {
            font-family: 'DM Mono', monospace;
            color: var(--gold);
        }

        /* ---- DISCARD MODE HINT ---- */
        .discard-hint {
            font-family: 'DM Mono', monospace;
            font-size: 10px;
            color: var(--red);
            letter-spacing: 2px;
            opacity: 0;
            transition: opacity 0.3s;
            height: 16px;
        }
        .discard-hint.visible { opacity: 1; }

        .tile.wildcard {
            border-color: var(--neon, #a78bfa);
            color: #a78bfa;
            background: rgba(167,139,250,0.08);
            font-size: 32px;
        }
        .tile.wildcard .tile-val {
            color: #a78bfa;
        }
        .tile.wildcard.selected {
            border-color: #a78bfa;
            background: rgba(167,139,250,0.2);
            color: #a78bfa;
            box-shadow: 0 12px 24px rgba(167,139,250,0.25);
        }

        /* ---- LETTER PICKER ---- */
        #letter-picker {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 300;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(6px);
        }
        #letter-picker.active { display: flex; }

        .picker-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            animation: modalIn 0.25s ease;
        }

        .picker-title {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 700;
            color: #a78bfa;
        }

        .picker-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 6px;
        }

        .picker-letter {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 700;
            width: 44px;
            height: 52px;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text);
            transition: all 0.12s;
            position: relative;
        }

        .picker-letter .pl-val {
            font-family: 'DM Mono', monospace;
            font-size: 8px;
            color: var(--text-dim);
            margin-top: 1px;
        }

        .picker-letter:hover {
            border-color: #a78bfa;
            background: rgba(167,139,250,0.15);
            color: #a78bfa;
            transform: scale(1.1);
        }

        .picker-cancel {
            font-family: 'DM Mono', monospace;
            font-size: 10px;
            letter-spacing: 2px;
            color: var(--text-muted);
            background: transparent;
            border: 1px solid var(--border);
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        .picker-cancel:hover { border-color: var(--red); color: var(--red); }
        .score-pop {
            position: fixed;
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            font-weight: 900;
            color: var(--gold-light);
            pointer-events: none;
            z-index: 200;
            animation: scorePop 1.2s ease forwards;
        }
        @keyframes scorePop {
            0% { transform: translateY(0) scale(0.8); opacity: 1; }
            100% { transform: translateY(-80px) scale(1.1); opacity: 0; }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .tile { width: 52px; height: 64px; font-size: 22px; }
            .word-letter { width: 42px; height: 50px; font-size: 28px; }
            .hud { gap: 14px; padding: 10px 14px; }
            .hud-value { font-size: 18px; }
        }
    </style>
</head>
<body>

<!-- ======== START SCREEN ======== -->
<div id="screen-start" class="screen active">
    <div class="logo">
        <div class="logo-title">PalabraRogue</div>
        <div class="logo-sub">Juego de palabras ¬∑ Roguelike</div>
    </div>
    <div class="start-info">
        Forma palabras con tus letras<br>
        Supera el objetivo de cada ronda<br>
        Compra mejoras y avanza hacia el jefe
    </div>
    <button class="start-btn" onclick="startGame()">Comenzar</button>
    <div id="load-status" style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text-dim);letter-spacing:2px;"></div>
</div>

<!-- ======== GAME SCREEN ======== -->
<div id="screen-game" class="screen">

    <!-- HUD -->
    <div class="hud">
        <div class="hud-section">
            <div class="hud-label">Puntos</div>
            <div class="hud-value" id="hud-score">0</div>
        </div>
        <div class="hud-sep"></div>
        <div class="hud-section">
            <div class="hud-label">Intentos</div>
            <div class="hud-value red" id="hud-attempts">5</div>
        </div>
        <div class="hud-sep"></div>
        <div class="hud-section">
            <div class="hud-label">Monedas</div>
            <div class="hud-value green" id="hud-coins">0</div>
        </div>
        <div class="hud-sep"></div>
        <div class="hud-progress">
            <div class="hud-progress-labels">
                <span id="hud-prog-cur">0</span>
                <span id="hud-prog-goal">objetivo: 100</span>
            </div>
            <div class="progress-bar-outer">
                <div class="progress-bar-inner" id="hud-bar" style="width:0%"></div>
            </div>
            <div class="hud-round" id="hud-round">Nivel 1 ¬∑ Ronda 1/3</div>
        </div>
    </div>

    <!-- GAME BODY -->
    <div class="game-body">

        <!-- BOSS INDICATOR (hidden by default) -->
        <div class="boss-indicator" id="boss-indicator" style="display:none">‚öî RONDA JEFE</div>

        <!-- WORD AREA -->
        <div class="word-area">
            <div class="word-display" id="word-display">
                <div class="word-placeholder">selecciona letras de tu mano</div>
            </div>
            <div class="word-score-preview" id="word-score-preview"></div>
            <div class="feedback" id="feedback"></div>
            <div class="word-actions">
                <button class="btn btn-clear" id="btn-clear" onclick="clearWord()" disabled>Limpiar</button>
                <button class="btn btn-play" id="btn-play" onclick="playWord()" disabled>Jugar</button>
            </div>
        </div>

        <!-- HAND -->
        <div class="hand-section">
            <div class="hand-label">Tu mano</div>
            <div class="hand" id="hand"></div>
            <div class="discard-hint" id="discard-hint">SELECCIONA LETRAS A DESCARTAR</div>
            <div class="hand-controls">
                <button class="btn btn-hand" onclick="shuffleHand()">‚ü≥ Revolver</button>
                <button class="btn btn-discard-mode" id="btn-discard" onclick="toggleDiscardMode()">‚úï Descartar</button>
                <span class="counter-badge" id="discard-count"></span>
            </div>
            <div class="bag-info" id="bag-info"></div>
        </div>

        <!-- LOG -->
        <div class="log" id="log"></div>

    </div>
</div>

<!-- ======== MODAL: ROUND WIN ======== -->
<div class="modal-overlay" id="modal-round-win">
    <div class="modal">
        <div class="big-emoji">‚ú®</div>
        <div class="modal-title" id="rw-title">¬°Ronda Superada!</div>
        <div class="modal-sub" id="rw-sub">Has alcanzado el objetivo</div>
        <div class="modal-stat">
            <div class="modal-stat-label">Puntos conseguidos:</div>
            <div class="modal-stat-val" id="rw-score">0</div>
        </div>
        <div class="modal-stat">
            <div class="modal-stat-label">Monedas ganadas:</div>
            <div class="modal-stat-val" id="rw-coins">+0 ü™ô</div>
        </div>
        <button class="btn btn-play" onclick="goToShop()" style="margin-top:8px">Ir a la Tienda ‚Üí</button>
    </div>
</div>

<!-- ======== MODAL: SHOP ======== -->
<div class="modal-overlay" id="modal-shop">
    <div class="modal">
        <div class="modal-title">Tienda</div>
        <div class="modal-sub" id="shop-sub">Siguiente: Nivel 1 ¬∑ Ronda 2</div>
        <div style="display:flex;gap:8px;align-items:center">
            <div class="modal-stat-label">Tus monedas:</div>
            <div class="coins-display" id="shop-coins">0 ü™ô</div>
        </div>
        <div class="shop-grid" id="shop-grid"></div>
        <button class="btn btn-play" onclick="nextRound()">Continuar ‚Üí</button>
    </div>
</div>

<!-- ======== MODAL: GAME OVER ======== -->
<div class="modal-overlay" id="modal-gameover">
    <div class="modal">
        <div class="big-emoji">üíÄ</div>
        <div class="modal-title">Derrota</div>
        <div class="modal-sub">Se acabaron los intentos</div>
        <div class="result-stats" id="gameover-stats"></div>
        <button class="btn btn-play" onclick="resetGame()">Volver a intentarlo</button>
    </div>
</div>

<!-- ======== MODAL: VICTORY ======== -->
<div class="modal-overlay" id="modal-victory">
    <div class="modal">
        <div class="big-emoji">üèÜ</div>
        <div class="modal-title">¬°Victoria!</div>
        <div class="modal-sub">Has completado todos los niveles</div>
        <div class="result-stats" id="victory-stats"></div>
        <button class="btn btn-play" onclick="resetGame()">Jugar de nuevo</button>
    </div>
</div>

<!-- ======== LETTER PICKER (comod√≠n) ======== -->
<div id="letter-picker">
    <div class="picker-box">
        <div class="picker-title">‚ú¶ Elige una letra para el comod√≠n</div>
        <div class="picker-grid" id="picker-grid"></div>
        <button class="picker-cancel" onclick="closePicker()">Cancelar</button>
    </div>
</div>

<script>
// ============================================================
//  CONFIGURACI√ìN DEL JUEGO
// ============================================================
const CONFIG = {
    HAND_SIZE: 7,
    BAG_SIZE: 100,
    MAX_ROUNDS: 3,      // rondas normales por nivel antes del jefe
    MAX_LEVELS: 3,
    BASE_ATTEMPTS: 5,
    BASE_DISCARDS: 2,
    // Objetivo base de puntos por ronda
    // Nivel 1: R1=15, R2=25, R3=35, Jefe=50
    // Nivel 2: R1=60, R2=80, R3=100, Jefe=140
    // Nivel 3: R1=130, R2=160, R3=190, Jefe=250
    roundGoal: (level, round, isBoss) => {
        const goals = [
            [15, 25, 35, 50],   // nivel 1: rondas 1-3 y jefe
            [60, 80, 100, 140], // nivel 2
            [130, 160, 190, 250], // nivel 3
        ];
        const lvl = goals[Math.min(level - 1, goals.length - 1)];
        if (isBoss) return lvl[3];
        return lvl[Math.min(round - 1, 2)];
    },
    // Monedas por ronda completada
    coinsPerRound: (score, goal) => {
        const ratio = score / goal;
        if (ratio >= 2) return 5;
        if (ratio >= 1.5) return 4;
        return 3;
    }
};

// Distribuci√≥n de letras ponderada por frecuencia en espa√±ol
const LETTER_POOL = [
    ...Array(12).fill('A'), ...Array(12).fill('E'), ...Array(9).fill('O'),
    ...Array(6).fill('I'),  ...Array(6).fill('U'),
    ...Array(6).fill('S'),  ...Array(5).fill('N'), ...Array(5).fill('R'),
    ...Array(5).fill('L'),  ...Array(4).fill('T'), ...Array(4).fill('D'),
    ...Array(3).fill('C'),  ...Array(3).fill('M'), ...Array(3).fill('P'),
    ...Array(2).fill('B'),  ...Array(2).fill('G'), ...Array(2).fill('V'),
    ...Array(2).fill('F'),  ...Array(2).fill('H'), ...Array(2).fill('Y'),
    ...Array(1).fill('J'),  ...Array(2).fill('√ë'), ...Array(1).fill('Q'),
    ...Array(1).fill('X'),  ...Array(1).fill('Z'), ...Array(1).fill('W'),
    ...Array(1).fill('K'),
    ...Array(3).fill('*'), // comodines
];

const LETTER_VALUES = {
    A:1,E:1,O:1,I:1,U:1,S:1,N:1,R:1,L:1,T:1,
    D:2,G:2, B:3,C:3,M:3,P:3, F:4,H:4,V:4,Y:4,
    J:6,√ë:6,X:6, K:8,W:8,Z:8, Q:10
};

const ALL_LETTERS = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','√ë','O','P','Q','R','S','T','U','V','W','X','Y','Z'];

let pickerCallback = null;

function openPicker(tileId) {
    const grid = document.getElementById('picker-grid');
    grid.innerHTML = '';
    ALL_LETTERS.forEach(letter => {
        const div = document.createElement('div');
        div.className = 'picker-letter';
        div.innerHTML = `${letter}<span class="pl-val">${LETTER_VALUES[letter]||1}</span>`;
        div.onclick = () => chooseLetter(tileId, letter);
        grid.appendChild(div);
    });
    document.getElementById('letter-picker').classList.add('active');
}

function chooseLetter(tileId, letter) {
    const tile = gameState.hand.find(t => t.id === tileId);
    if (tile) {
        tile.chosenLetter = letter; // la letra elegida, la original sigue siendo '*'
    }
    closePicker();
    // Seleccionar la ficha autom√°ticamente tras elegir
    if (!gameState.selectedIds.includes(tileId)) {
        gameState.selectedIds.push(tileId);
    }
    renderWordDisplay();
    renderHand();
}

function closePicker() {
    document.getElementById('letter-picker').classList.remove('active');
}

// Devuelve la letra efectiva de una ficha (comod√≠n ‚Üí letra elegida o '*')
function effectiveLetter(tile) {
    if (tile.letter === '*') return tile.chosenLetter || '*';
    return tile.letter;
}

const SHOP_ITEMS = [
    { id: 'more_attempts', name: '+2 Intentos', desc: 'A√±ade 2 intentos extra a la siguiente ronda.', price: 3 },
    { id: 'multiplier', name: '√ó1.5 Multiplicador', desc: 'Tus puntos valen √ó1.5 en la siguiente ronda.', price: 4 },
    { id: 'bigger_hand', name: 'Mano Grande', desc: 'Roba una letra extra al inicio de la siguiente ronda.', price: 3 },
    { id: 'more_discards', name: '+2 Descartes', desc: 'A√±ade 2 descartes extra a la siguiente ronda.', price: 2 },
];

// ============================================================
//  ESTADO DEL JUEGO
// ============================================================
let dictionary = new Set();
let dictLoaded = false;

let gameState = {};

function freshState() {
    return {
        score: 0,
        coins: 0,
        level: 1,
        round: 1,
        isBoss: false,
        goal: 0,
        attempts: CONFIG.BASE_ATTEMPTS,
        attemptsLeft: CONFIG.BASE_ATTEMPTS,
        discards: CONFIG.BASE_DISCARDS,
        discardsLeft: CONFIG.BASE_DISCARDS,
        bag: [],
        hand: [],       // array of {letter, id}
        selectedIds: [], // ids in order of selection
        discardMode: false,
        multiplier: 1,
        handBonus: 0,   // extra hand size from shop
        totalWords: 0,
        totalScore: 0,
    };
}

// ============================================================
//  NORMALIZACI√ìN
// ============================================================
function normalizeWord(word) {
    return word.toUpperCase()
        .replace(/√ë/g, '\x00')           // protege la √ë temporalmente
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // quita tildes (√°‚Üía, √©‚Üíe, etc.)
        .replace(/\x00/g, '√ë');          // restaura la √ë
}

// ============================================================
//  DICCIONARIO
// ============================================================
async function loadDictionary() {
    document.getElementById('load-status').textContent = 'Cargando diccionario...';
    try {
        // Intenta ambas variantes de nombre (GitHub Pages es case-sensitive)
        let res = await fetch('Diccionario.txt');
        if (!res.ok) res = await fetch('diccionario.txt');
        if (!res.ok) throw new Error('no encontrado');
        const text = await res.text();
        const words = text.split(/\r?\n/).map(w => normalizeWord(w.trim())).filter(w => w.length >= 2);
        dictionary = new Set(words);
        dictLoaded = true;
        document.getElementById('load-status').textContent = `‚úì ${dictionary.size.toLocaleString()} palabras cargadas`;
    } catch(e) {
        // Fallback: small built-in dictionary for testing
        const sample = ['CASA','MESA','SILLA','LIBRO','AGUA','FUEGO','TIERRA','AIRE',
            'SOL','LUNA','MAR','RIO','MONTE','CAMPO','CALLE','CIUDAD',
            'AMOR','VIDA','TIEMPO','MUNDO','MANO','OJO','CARA','PIE',
            'GATO','PERRO','PATO','TORO','LOBO','RANA','PATO','VACA',
            'ROSA','FLOR','ARBOL','PLANTA','HOJA','RAMA','RAIZ','FRUTO',
            'PAN','SAL','VINO','LECHE','CARNE','PESCA','SOPA','ARROZ',
            'ROJO','AZUL','VERDE','BLANCO','NEGRO','GRIS','CLARO','OSCURO',
            'UNO','DOS','TRES','SEIS','OCHO','CIEN','MIL',
            'SER','ESTAR','TENER','PODER','HACER','DECIR','VER','DAR',
            'SALA','SUELO','TECHO','PUERTA','VENTANA','MURO','PARED','PISO',
            'ISLA','PLAYA','LAGO','BOSQUE','SELVA','DESIERTO','VALLE','ROCA',
            'NAVE','TREN','AUTO','MOTO','BICI','AVION','BARCO','BUS',
            'REY','REINA','NOBLE','DUQUE','CONDE','BARON','CABALLERO',
            'ESPADA','LANZA','ARCO','FLECHA','ESCUDO','ARMADURA','CASCO',
            'ORO','PLATA','COBRE','HIERRO','ACERO','BRONCE','PIEDRA','MADERA',
            'LETRA','PALABRA','LIBRO','PAGINA','LINEA','TEXTO','NOTA','CARTA',
            'JUEGO','RONDA','TURNO','PUNTO','CARTA','DADO','FICHA','TORRE'];
        dictionary = new Set(sample.map(w => w.toUpperCase()));
        dictLoaded = true;
        document.getElementById('load-status').textContent = '‚ö† Diccionario de prueba (sube diccionario.txt)';
    }
}

function isValidWord(word) {
    return word.length >= 2 && dictionary.has(normalizeWord(word));
}

// ============================================================
//  C√ìDIGO KONAMI ‚Äî MODO DIOS
// ============================================================
const KONAMI = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
let konamiIdx = 0;
let godMode = false;

document.addEventListener('keydown', e => {
    if (e.key === KONAMI[konamiIdx]) {
        konamiIdx++;
        if (konamiIdx === KONAMI.length) {
            konamiIdx = 0;
            toggleGodMode();
        }
    } else {
        konamiIdx = e.key === KONAMI[0] ? 1 : 0;
    }
});

function toggleGodMode() {
    godMode = !godMode;
    if (godMode) showGodPanel();
    else closeGodPanel();
}

function showGodPanel() {
    let panel = document.getElementById('god-panel');
    if (!panel) {
        panel = document.createElement('div');
        panel.id = 'god-panel';
        panel.style.cssText = `
            position:fixed; bottom:20px; right:20px; z-index:9999;
            background:#1a1030; border:2px solid #a78bfa;
            border-radius:14px; padding:20px; min-width:240px;
            font-family:'DM Mono',monospace; font-size:12px;
            box-shadow: 0 0 30px rgba(167,139,250,0.4);
            color:#e0d0ff;
        `;
        panel.innerHTML = `
            <div style="font-size:14px;font-weight:700;color:#a78bfa;margin-bottom:14px;letter-spacing:2px">‚ö° MODO DIOS</div>
            <div style="display:flex;flex-direction:column;gap:8px;">
                <button onclick="godWinRound()" style="${godBtnStyle()}">‚úì Ganar ronda</button>
                <button onclick="godMaxScore()" style="${godBtnStyle()}">‚òÖ Puntos m√°ximos</button>
                <button onclick="godNextLevel()" style="${godBtnStyle()}">‚è≠ Siguiente nivel</button>
                <button onclick="godGotoLevel(1)" style="${godBtnStyle()}">‚ë† Ir a Nivel 1</button>
                <button onclick="godGotoLevel(2)" style="${godBtnStyle()}">‚ë° Ir a Nivel 2</button>
                <button onclick="godGotoLevel(3)" style="${godBtnStyle()}">‚ë¢ Ir a Nivel 3</button>
                <button onclick="godGotoBoss()" style="${godBtnStyle()}">‚öî Ir al Jefe actual</button>
                <button onclick="godAddCoins()" style="${godBtnStyle()}">ü™ô +20 monedas</button>
                <button onclick="closeGodPanel()" style="${godBtnStyle('close')}">‚úï Cerrar</button>
            </div>
        `;
        document.body.appendChild(panel);
    } else {
        panel.style.display = 'block';
    }
}

function godBtnStyle(type) {
    const base = 'background:#2a1a4a;border:1px solid #a78bfa;color:#e0d0ff;padding:7px 12px;border-radius:6px;cursor:pointer;font-family:DM Mono,monospace;font-size:11px;letter-spacing:1px;transition:all 0.15s;width:100%;text-align:left;';
    return type === 'close' ? base + 'border-color:#f07070;color:#f07070;' : base;
}

function closeGodPanel() {
    godMode = false;
    const p = document.getElementById('god-panel');
    if (p) p.style.display = 'none';
}

function godWinRound() {
    if (document.getElementById('screen-game').classList.contains('active')) {
        gameState.score = gameState.goal;
        renderHUD();
        setTimeout(roundWin, 200);
    }
}

function godMaxScore() {
    if (document.getElementById('screen-game').classList.contains('active')) {
        gameState.score = gameState.goal * 2;
        renderHUD();
        addLog('‚ö° GOD MODE: puntos m√°ximos', 'sys');
    }
}

function godNextLevel() {
    hideAllModals();
    gameState.level = Math.min(gameState.level + 1, CONFIG.MAX_LEVELS);
    gameState.round = 1;
    gameState.isBoss = false;
    gameState.bag = [];
    applyPurchases();
    initRound();
    showScreen('game');
    addLog(`‚ö° GOD MODE: Nivel ${gameState.level}`, 'sys');
}

function godGotoLevel(lvl) {
    hideAllModals();
    gameState.level = lvl;
    gameState.round = 1;
    gameState.isBoss = false;
    gameState.bag = [];
    gameState.coins = 10;
    applyPurchases();
    initRound();
    showScreen('game');
    addLog(`‚ö° GOD MODE: Nivel ${lvl}`, 'sys');
}

function godGotoBoss() {
    hideAllModals();
    gameState.round = CONFIG.MAX_ROUNDS + 1;
    gameState.isBoss = true;
    gameState.bag = gameState.bag.length < 20 ? buildBag() : gameState.bag;
    applyPurchases();
    initRound();
    showScreen('game');
    addLog(`‚ö° GOD MODE: Ronda Jefe`, 'sys');
}

function godAddCoins() {
    gameState.coins += 20;
    renderHUD();
    const shopCoins = document.getElementById('shop-coins');
    if (shopCoins) shopCoins.textContent = `${gameState.coins} ü™ô`;
    addLog('‚ö° GOD MODE: +20 monedas', 'sys');
}

// ============================================================
//  INICIO / RESET
// ============================================================
async function startGame() {
    if (!dictLoaded) await loadDictionary();
    gameState = freshState();
    applyPurchases();
    initRound();
    showScreen('game');
}

function resetGame() {
    hideAllModals();
    showScreen('start');
}

function showScreen(name) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-' + name).classList.add('active');
}

// ============================================================
//  BOLSA & MANO
// ============================================================
function buildBag() {
    const pool = [...LETTER_POOL];
    // Shuffle
    for (let i = pool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [pool[i], pool[j]] = [pool[j], pool[i]];
    }
    return pool.slice(0, CONFIG.BAG_SIZE);
}

function drawFromBag(n) {
    const gs = gameState;
    const drawn = [];
    for (let i = 0; i < n && gs.bag.length > 0; i++) {
        drawn.push(gs.bag.pop());
    }
    return drawn;
}

function fillHand() {
    const gs = gameState;
    const target = CONFIG.HAND_SIZE + gs.handBonus;
    const empty = gs.hand.filter(t => t.letter === null).length;
    const need = Math.min(empty, gs.bag.length);
    const drawn = drawFromBag(need);
    let di = 0;
    for (let i = 0; i < gs.hand.length && di < drawn.length; i++) {
        if (gs.hand[i].letter === null) {
            gs.hand[i].letter = drawn[di++];
        }
    }
}

let tileIdCounter = 0;
function makeTile(letter) {
    return { id: tileIdCounter++, letter };
}

// ============================================================
//  RONDA
// ============================================================
let pendingPurchases = [];

function applyPurchases() {
    // Reset per-round bonuses
    gameState.multiplier = 1;
    gameState.handBonus = 0;
    // Apply pending shop items
    pendingPurchases.forEach(id => {
        if (id === 'more_attempts') gameState.attempts = CONFIG.BASE_ATTEMPTS + 2;
        if (id === 'multiplier') gameState.multiplier = 1.5;
        if (id === 'bigger_hand') gameState.handBonus = 1;
        if (id === 'more_discards') gameState.discards = CONFIG.BASE_DISCARDS + 2;
    });
    pendingPurchases = [];
}

function initRound() {
    const gs = gameState;
    gs.score = 0;
    gs.attemptsLeft = gs.attempts;
    gs.discardsLeft = gs.discards;
    gs.selectedIds = [];
    gs.discardMode = false;
    gs.isBoss = (gs.round > CONFIG.MAX_ROUNDS);
    gs.goal = CONFIG.roundGoal(gs.level, gs.isBoss ? 4 : gs.round, gs.isBoss);

    // Build bag fresh each level
    if (gs.round === 1 && !gs.isBoss) {
        gs.bag = buildBag();
    }

    // Fill hand
    const target = CONFIG.HAND_SIZE + gs.handBonus;
    gs.hand = Array.from({length: target}, () => makeTile(null));
    fillHand();

    clearWord();
    renderAll();
    addLog(`Ronda ${gs.isBoss ? 'JEFE' : gs.round} ‚Äî Objetivo: ${gs.goal} pts`, 'sys');
}

// ============================================================
//  RENDER
// ============================================================
function renderAll() {
    renderHUD();
    renderHand();
    renderWordDisplay();
}

function renderHUD() {
    const gs = gameState;
    document.getElementById('hud-score').textContent = gs.score;
    document.getElementById('hud-attempts').textContent = gs.attemptsLeft;
    document.getElementById('hud-coins').textContent = gs.coins;
    document.getElementById('hud-prog-cur').textContent = gs.score;
    document.getElementById('hud-prog-goal').textContent = `objetivo: ${gs.goal}`;
    const pct = Math.min(100, (gs.score / gs.goal) * 100);
    document.getElementById('hud-bar').style.width = pct + '%';
    const roundLabel = gs.isBoss
        ? `Nivel ${gs.level} ¬∑ ‚öî Jefe`
        : `Nivel ${gs.level} ¬∑ Ronda ${gs.round}/${CONFIG.MAX_ROUNDS}`;
    document.getElementById('hud-round').textContent = roundLabel;
    document.getElementById('boss-indicator').style.display = gs.isBoss ? 'block' : 'none';
}

function renderHand() {
    const gs = gameState;
    const handEl = document.getElementById('hand');
    handEl.innerHTML = '';

    gs.hand.forEach(tile => {
        const div = document.createElement('div');
        div.className = 'tile';
        if (!tile.letter) {
            div.classList.add('empty');
            div.textContent = '';
        } else {
            const isWild = tile.letter === '*';
            const displayLetter = isWild ? (tile.chosenLetter || '‚ú¶') : tile.letter;
            const displayVal = isWild ? (tile.chosenLetter ? LETTER_VALUES[tile.chosenLetter] || 1 : '?') : (LETTER_VALUES[tile.letter] || 1);

            div.textContent = displayLetter;
            if (isWild) div.classList.add('wildcard');

            const val = document.createElement('div');
            val.className = 'tile-val';
            val.textContent = displayVal;
            div.appendChild(val);

            if (gs.discardMode) {
                div.classList.add('discarding');
                if (gs.selectedIds.includes(tile.id)) div.style.opacity = '0.4';
                div.onclick = () => toggleDiscardSelect(tile.id);
            } else {
                if (gs.selectedIds.includes(tile.id)) div.classList.add('selected');
                div.onclick = () => {
                    if (isWild && !tile.chosenLetter) {
                        openPicker(tile.id); // abre el selector antes de seleccionar
                    } else {
                        toggleSelect(tile.id);
                    }
                };
            }
        }
        handEl.appendChild(div);
    });

    // Bag info
    document.getElementById('bag-info').textContent =
        gs.bag.length > 0 ? `BOLSA: ${gs.bag.length} letras restantes` : 'BOLSA VAC√çA';

    // Discard button
    const discardBtn = document.getElementById('btn-discard');
    const discardCount = document.getElementById('discard-count');
    discardBtn.disabled = gs.discardsLeft <= 0;
    discardBtn.classList.toggle('active', gs.discardMode);
    discardCount.textContent = `(${gs.discardsLeft} restantes)`;

    // Discard hint
    document.getElementById('discard-hint').classList.toggle('visible', gs.discardMode);
}

function renderWordDisplay() {
    const gs = gameState;
    const el = document.getElementById('word-display');
    const selected = gs.selectedIds.map(id => gs.hand.find(t => t.id === id)).filter(Boolean);

    if (selected.length === 0) {
        el.innerHTML = '<div class="word-placeholder">selecciona letras de tu mano</div>';
    } else {
        el.innerHTML = '';
        selected.forEach(tile => {
            const div = document.createElement('div');
            div.className = 'word-letter';
            const eff = effectiveLetter(tile);
            div.textContent = eff;
            if (tile.letter === '*') div.style.color = '#a78bfa';
            const val = document.createElement('div');
            val.className = 'letter-val';
            val.textContent = LETTER_VALUES[eff] || 1;
            div.appendChild(val);
            el.appendChild(div);
        });
    }

    const previewEl = document.getElementById('word-score-preview');
    if (selected.length >= 1) {
        const basePoints = selected.reduce((sum, t) => sum + (LETTER_VALUES[effectiveLetter(t)] || 1), 0);
        const lengthBonus = selected.length >= 6 ? 3 : selected.length >= 5 ? 2 : selected.length >= 4 ? 1 : 0;
        const rawPoints = basePoints + lengthBonus;
        const points = Math.round(rawPoints * gs.multiplier);
        let detail = `${basePoints} base`;
        if (lengthBonus > 0) detail += ` +${lengthBonus} bonus`;
        if (gs.multiplier > 1) detail += ` √ó${gs.multiplier}`;
        previewEl.innerHTML = `${points} pts <span class="preview-detail">(${detail})</span>`;
    } else {
        previewEl.innerHTML = '';
    }

    const hasWord = selected.length >= 2;
    document.getElementById('btn-play').disabled = !hasWord;
    document.getElementById('btn-clear').disabled = selected.length === 0;
}

// ============================================================
//  SELECCI√ìN
// ============================================================
function toggleSelect(id) {
    const gs = gameState;
    if (gs.discardMode) return;
    const idx = gs.selectedIds.indexOf(id);
    if (idx === -1) gs.selectedIds.push(id);
    else gs.selectedIds.splice(idx, 1);
    renderWordDisplay();
    renderHand();
}

function toggleDiscardSelect(id) {
    const gs = gameState;
    const idx = gs.selectedIds.indexOf(id);
    if (idx === -1) gs.selectedIds.push(id);
    else gs.selectedIds.splice(idx, 1);
    renderHand();
}

function clearWord() {
    gameState.selectedIds = [];
    renderWordDisplay();
    renderHand();
    setFeedback('', '');
}

// ============================================================
//  DESCARTAR
// ============================================================
function toggleDiscardMode() {
    const gs = gameState;
    if (gs.discardsLeft <= 0) return;
    gs.discardMode = !gs.discardMode;
    gs.selectedIds = [];

    if (!gs.discardMode) {
        // nothing
    } else {
        // Show confirm button in discard hint
    }

    renderHand();
    renderWordDisplay();

    if (gs.discardMode) {
        // Replace the discard button behavior temporarily
        document.getElementById('btn-discard').onclick = confirmDiscard;
        document.getElementById('btn-discard').textContent = '‚úì Confirmar descarte';
    } else {
        document.getElementById('btn-discard').onclick = toggleDiscardMode;
        document.getElementById('btn-discard').textContent = '‚úï Descartar';
    }
}

function confirmDiscard() {
    const gs = gameState;
    const toDiscard = [...gs.selectedIds];
    if (toDiscard.length === 0) {
        // Cancel discard mode
        gs.discardMode = false;
        gs.selectedIds = [];
        document.getElementById('btn-discard').onclick = toggleDiscardMode;
        document.getElementById('btn-discard').textContent = '‚úï Descartar';
        renderHand();
        return;
    }

    // Remove selected tiles and replace with null
    toDiscard.forEach(id => {
        const tile = gs.hand.find(t => t.id === id);
        if (tile) { tile.letter = null; tile.chosenLetter = null; }
    });

    gs.discardsLeft--;
    gs.selectedIds = [];
    gs.discardMode = false;

    document.getElementById('btn-discard').onclick = toggleDiscardMode;
    document.getElementById('btn-discard').textContent = '‚úï Descartar';

    fillHand();
    addLog(`Descarte usado (${gs.discardsLeft} restantes)`, 'sys');
    renderAll();
}

// ============================================================
//  REVOLVER
// ============================================================
function shuffleHand() {
    const gs = gameState;
    const letters = gs.hand.map(t => t.letter);
    // Fisher-Yates on letters only
    for (let i = letters.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [letters[i], letters[j]] = [letters[j], letters[i]];
    }
    gs.hand.forEach((t, i) => t.letter = letters[i]);
    gs.selectedIds = [];
    renderHand();
    renderWordDisplay();
}

// ============================================================
//  JUGAR PALABRA
// ============================================================
function playWord() {
    const gs = gameState;
    const selected = gs.selectedIds.map(id => gs.hand.find(t => t.id === id)).filter(Boolean);
    if (selected.length < 2) return;

    // Verificar que todos los comodines tienen letra elegida
    const unresolved = selected.find(t => t.letter === '*' && !t.chosenLetter);
    if (unresolved) {
        setFeedback('Elige una letra para el comod√≠n ‚ú¶', 'err');
        return;
    }

    const word = selected.map(t => effectiveLetter(t)).join('');

    if (!isValidWord(word)) {
        setFeedback(`"${word}" no es una palabra v√°lida`, 'err');
        clearWord();
        return;
    }

    // Calculate score
    const basePoints = selected.reduce((sum, t) => sum + (LETTER_VALUES[effectiveLetter(t)] || 1), 0);
    const lengthBonus = selected.length >= 6 ? 3 : selected.length >= 5 ? 2 : selected.length >= 4 ? 1 : 0;
    const rawPoints = basePoints + lengthBonus;
    const points = Math.round(rawPoints * gs.multiplier);

    gs.score += points;
    gs.totalScore += points;
    gs.totalWords++;
    gs.attemptsLeft--;

    // Remove used tiles
    gs.selectedIds.forEach(id => {
        const tile = gs.hand.find(t => t.id === id);
        if (tile) { tile.letter = null; tile.chosenLetter = null; }
    });
    gs.selectedIds = [];
    fillHand();

    setFeedback(`+${points} pts${gs.multiplier > 1 ? ` (√ó${gs.multiplier})` : ''}`, 'ok');
    addLog(word, 'ok', points);
    showScorePop(`+${points}`);
    renderAll();

    // Check win
    if (gs.score >= gs.goal) {
        setTimeout(roundWin, 600);
        return;
    }

    // Check game over
    if (gs.attemptsLeft <= 0) {
        setTimeout(gameOver, 500);
    }
}

// ============================================================
//  ROUND WIN / GAME OVER / PROGRESSION
// ============================================================
function roundWin() {
    const gs = gameState;
    const earned = CONFIG.coinsPerRound(gs.score, gs.goal);
    gs.coins += earned;

    const isBossWin = gs.isBoss;

    document.getElementById('rw-title').textContent = isBossWin ? '¬°Jefe Derrotado!' : '¬°Ronda Superada!';
    document.getElementById('rw-sub').textContent = isBossWin
        ? `Has completado el Nivel ${gs.level}`
        : `Has alcanzado ${gs.score} / ${gs.goal} pts`;
    document.getElementById('rw-score').textContent = gs.score;
    document.getElementById('rw-coins').textContent = `+${earned} ü™ô`;

    showModal('round-win');
}

function goToShop() {
    const gs = gameState;
    hideAllModals();

    // Determine next round
    const wasBoss = gs.isBoss;
    if (wasBoss) {
        gs.level++;
        gs.round = 1;
        if (gs.level > CONFIG.MAX_LEVELS) {
            victory();
            return;
        }
    } else {
        gs.round++;
    }

    // Reset per-round defaults
    gs.attempts = CONFIG.BASE_ATTEMPTS;
    gs.discards = CONFIG.BASE_DISCARDS;

    const nextLabel = gs.round > CONFIG.MAX_ROUNDS
        ? `Siguiente: Nivel ${gs.level} ¬∑ ‚öî Jefe`
        : `Siguiente: Nivel ${gs.level} ¬∑ Ronda ${gs.round}/${CONFIG.MAX_ROUNDS}`;
    document.getElementById('shop-sub').textContent = nextLabel;
    document.getElementById('shop-coins').textContent = `${gs.coins} ü™ô`;

    renderShop();
    showModal('shop');
}

function renderShop() {
    const gs = gameState;
    const grid = document.getElementById('shop-grid');
    grid.innerHTML = '';
    SHOP_ITEMS.forEach(item => {
        const canAfford = gs.coins >= item.price;
        const div = document.createElement('div');
        div.className = 'shop-item' + (canAfford ? '' : ' cant-afford');
        div.innerHTML = `
            <div class="shop-item-name">${item.name}</div>
            <div class="shop-item-desc">${item.desc}</div>
            <div class="shop-item-price">${item.price} ü™ô</div>
        `;
        if (canAfford) {
            div.onclick = () => buyItem(item);
        }
        grid.appendChild(div);
    });
}

function buyItem(item) {
    const gs = gameState;
    if (gs.coins < item.price) return;
    gs.coins -= item.price;
    pendingPurchases.push(item.id);
    document.getElementById('shop-coins').textContent = `${gs.coins} ü™ô`;
    addLog(`Comprado: ${item.name}`, 'sys');
    renderShop();
}

function nextRound() {
    hideAllModals();
    applyPurchases();
    initRound();
}

function gameOver() {
    const gs = gameState;
    const stats = document.getElementById('gameover-stats');
    stats.innerHTML = `
        <div class="result-stat-row"><span>Nivel alcanzado</span><span>${gs.level}</span></div>
        <div class="result-stat-row"><span>Ronda</span><span>${gs.round}</span></div>
        <div class="result-stat-row"><span>Palabras jugadas</span><span>${gs.totalWords}</span></div>
        <div class="result-stat-row"><span>Puntos totales</span><span>${gs.totalScore}</span></div>
    `;
    showModal('gameover');
}

function victory() {
    const gs = gameState;
    const stats = document.getElementById('victory-stats');
    stats.innerHTML = `
        <div class="result-stat-row"><span>Palabras jugadas</span><span>${gs.totalWords}</span></div>
        <div class="result-stat-row"><span>Puntos totales</span><span>${gs.totalScore}</span></div>
        <div class="result-stat-row"><span>Monedas restantes</span><span>${gs.coins} ü™ô</span></div>
    `;
    showModal('victory');
}

// ============================================================
//  UI HELPERS
// ============================================================
function setFeedback(msg, type) {
    const el = document.getElementById('feedback');
    el.textContent = msg;
    el.className = 'feedback ' + type;
}

function addLog(msg, type, pts) {
    const log = document.getElementById('log');
    const entry = document.createElement('div');
    entry.className = 'log-entry ' + type;
    if (type === 'sys') {
        entry.innerHTML = `<span>‚Äî ${msg}</span>`;
    } else {
        entry.innerHTML = `<span class="log-word">${msg}</span>${pts !== undefined ? `<span class="log-pts">+${pts} pts</span>` : ''}`;
    }
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
}

function showScorePop(text) {
    const pop = document.createElement('div');
    pop.className = 'score-pop';
    pop.textContent = text;
    // Position near word area
    const wa = document.querySelector('.word-area');
    const rect = wa.getBoundingClientRect();
    pop.style.left = (rect.left + rect.width / 2 - 30) + 'px';
    pop.style.top = (rect.top - 10 + window.scrollY) + 'px';
    document.body.appendChild(pop);
    setTimeout(() => pop.remove(), 1300);
}

function showModal(name) {
    document.getElementById('modal-' + name).classList.add('active');
}

function hideAllModals() {
    document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
}

// ============================================================
//  LOAD DICTIONARY ON PAGE LOAD
// ============================================================
window.addEventListener('load', () => {
    loadDictionary();
});
</script>
</body>
</html>
