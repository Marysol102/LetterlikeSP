<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PalabraRogue</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #1a1f2e;
            --surface: #242b3d;
            --surface2: #2e3750;
            --border: rgba(255,255,255,0.14);
            --gold: #e8c46a;
            --gold-light: #f5d98a;
            --gold-dim: rgba(232,196,106,0.18);
            --red: #f07070;
            --green: #6ed49a;
            --blue: #70aaf0;
            --text: #f0eadc;
            --text-muted: #a09880;
            --text-dim: #706858;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        html {
            font-size: 14px; /* base */
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(ellipse 60% 40% at 20% 10%, rgba(201,168,76,0.04) 0%, transparent 60%),
                radial-gradient(ellipse 50% 30% at 80% 80%, rgba(82,148,224,0.04) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        /* ---- SCREENS ---- */
        .screen { display: none; width: 100%; max-width: 960px; padding: 16px; position: relative; z-index: 1; }
        .screen.active { display: flex; flex-direction: column; align-items: center; }

        /* ---- START SCREEN ---- */
        #screen-start {
            min-height: 100vh;
            justify-content: center;
            gap: 40px;
        }

        .logo {
            text-align: center;
        }

        .logo-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(48px, 7vw, 90px);
            font-weight: 900;
            color: var(--gold);
            letter-spacing: -2px;
            line-height: 1;
            text-shadow: 0 0 60px rgba(232,196,106,0.35);
        }

        .logo-sub {
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            letter-spacing: 6px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 14px;
        }

        .start-btn {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 700;
            background: var(--gold);
            color: #0d0f14;
            border: none;
            padding: 16px 48px;
            border-radius: 4px;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .start-btn:hover {
            background: var(--gold-light);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(201,168,76,0.3);
        }

        .start-info {
            font-size: 12px;
            color: var(--text-muted);
            text-align: center;
            line-height: 1.8;
        }

        /* ---- HUD ---- */
        #screen-game { padding-top: 0; gap: 0; }

        .hud {
            width: 100%;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 10px 20px 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .hud-top {
            display: flex;
            align-items: center;
            gap: 0;
        }

        .hud-section {
            display: flex;
            flex-direction: column;
            gap: 2px;
            flex: 1;
            text-align: center;
        }

        .hud-section:first-child { text-align: left; }
        .hud-section:last-child { text-align: right; }

        .hud-label {
            font-family: 'DM Mono', monospace;
            font-size: 9px;
            letter-spacing: 3px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .hud-value {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--gold);
            line-height: 1;
        }

        .hud-value.red { color: var(--red); }
        .hud-value.green { color: var(--green); }

        .btn-exit-hud {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            font-size: 14px;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s;
            padding: 0;
        }
        .btn-exit-hud:hover { border-color: var(--red); color: var(--red); }
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .hud-progress-labels {
            display: flex;
            justify-content: space-between;
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            color: var(--text-muted);
        }

        .hud-round {
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            color: var(--text-dim);
            white-space: nowrap;
        }

        .progress-bar-outer {
            height: 7px;
            background: var(--surface2);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, var(--gold), var(--gold-light));
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* ---- GAME BODY ---- */
        .game-body {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 20px;
            gap: 14px;
        }

        /* ---- WORD DISPLAY ---- */
        .word-area {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            min-height: 130px;
            justify-content: center;
        }

        .word-display {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
            min-height: 66px;
            align-items: center;
        }

        .word-letter {
            font-family: 'Playfair Display', serif;
            font-size: 38px;
            font-weight: 900;
            color: var(--gold);
            background: var(--gold-dim);
            border: 1px solid rgba(232,196,106,0.3);
            width: 56px;
            height: 66px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            animation: letterPop 0.15s ease;
            position: relative;
        }

        .word-letter .letter-val {
            position: absolute;
            bottom: 3px;
            right: 5px;
            font-family: 'DM Mono', monospace;
            font-size: 9px;
            color: var(--gold);
            opacity: 0.7;
        }

        @keyframes letterPop {
            0% { transform: scale(0.7); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .word-score-preview {
            font-family: 'Playfair Display', serif;
            font-size: 26px;
            font-weight: 700;
            color: var(--gold);
            height: 32px;
            transition: all 0.2s;
            letter-spacing: 1px;
        }

        .word-score-preview .preview-detail {
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 400;
            margin-left: 6px;
            letter-spacing: 2px;
        }
            font-size: 12px;
            letter-spacing: 4px;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .word-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            letter-spacing: 2px;
            text-transform: uppercase;
            padding: 9px 20px;
            border-radius: 6px;
            border: 1px solid;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn:disabled { opacity: 0.3; cursor: not-allowed; }

        .btn-play {
            background: var(--gold);
            color: #0d0f14;
            border-color: var(--gold);
            font-weight: 500;
        }
        .btn-play:hover:not(:disabled) {
            background: var(--gold-light);
            box-shadow: 0 4px 20px rgba(201,168,76,0.3);
        }

        .btn-clear {
            background: transparent;
            color: var(--text-muted);
            border-color: var(--border);
        }
        .btn-clear:hover:not(:disabled) {
            border-color: var(--red);
            color: var(--red);
        }

        /* ---- FEEDBACK ---- */
        .feedback {
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            letter-spacing: 2px;
            height: 20px;
            text-align: center;
            transition: all 0.3s;
        }
        .feedback.ok { color: var(--green); }
        .feedback.err { color: var(--red); }

        /* ---- HAND ---- */
        .hand-section {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 14px;
        }

        .hand-label {
            font-family: 'DM Mono', monospace;
            font-size: 10px;
            letter-spacing: 4px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .hand {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tile {
            font-family: 'Playfair Display', serif;
            font-size: 32px;
            font-weight: 900;
            width: 72px;
            height: 86px;
            background: var(--surface2);
            border: 2px solid var(--border);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            user-select: none;
            color: var(--text);
        }

        .tile .tile-val {
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 400;
            margin-top: 3px;
        }

        .tile:hover:not(.selected):not(.discarding):not(.empty) {
            border-color: rgba(201,168,76,0.5);
            background: rgba(201,168,76,0.05);
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .tile.selected {
            border-color: var(--gold);
            background: var(--gold-dim);
            color: var(--gold);
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(201,168,76,0.2);
        }

        .tile.empty {
            opacity: 0.2;
            cursor: default;
            border-style: dashed;
        }

        .tile.discarding {
            border-color: var(--red);
            background: rgba(224,82,82,0.1);
            color: var(--red);
            cursor: pointer;
        }

        .tile.discarding:hover {
            background: rgba(224,82,82,0.2);
            transform: translateY(-4px);
        }

        /* ---- HAND CONTROLS ---- */
        .hand-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-hand {
            background: transparent;
            color: var(--text-muted);
            border-color: var(--border);
            font-size: 11px;
            padding: 7px 14px;
        }
        .btn-hand:hover:not(:disabled) {
            border-color: var(--text-muted);
            color: var(--text);
        }

        .btn-discard-mode {
            background: transparent;
            color: var(--red);
            border-color: rgba(224,82,82,0.3);
            font-size: 13px;
            padding: 9px 18px;
        }
        .btn-discard-mode:hover:not(:disabled) {
            background: rgba(224,82,82,0.1);
        }
        .btn-discard-mode.active {
            background: rgba(224,82,82,0.15);
            border-color: var(--red);
        }

        .counter-badge {
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            color: var(--text-dim);
        }

        /* ---- BAG INFO ---- */
        .bag-info {
            font-family: 'DM Mono', monospace;
            font-size: 13px;
            color: var(--text-dim);
            letter-spacing: 2px;
        }

        /* ---- LOG ---- */
        .log {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 18px;
            max-height: 150px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .log::-webkit-scrollbar { width: 4px; }
        .log::-webkit-scrollbar-track { background: transparent; }
        .log::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .log-entry {
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            gap: 12px;
            align-items: baseline;
        }
        .log-entry.ok .log-word { color: var(--green); }
        .log-entry.err .log-word { color: var(--red); }
        .log-entry.sys { color: var(--text-dim); font-style: italic; }
        .log-word { color: var(--gold); font-weight: 500; letter-spacing: 2px; }
        .log-pts { color: var(--gold-light); }

        /* ---- MODALS ---- */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
            padding: 16px;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px 24px;
            max-width: 480px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 18px;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            0% { transform: scale(0.9) translateY(20px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 26px;
            font-weight: 900;
            color: var(--gold);
            text-align: center;
        }

        .modal-sub {
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            letter-spacing: 3px;
            color: var(--text-muted);
            text-align: center;
            text-transform: uppercase;
        }

        .modal-stat {
            display: flex;
            gap: 8px;
            align-items: baseline;
        }
        .modal-stat-label { font-size: 13px; color: var(--text-muted); }
        .modal-stat-val {
            font-family: 'Playfair Display', serif;
            font-size: 32px;
            font-weight: 900;
            color: var(--gold);
        }

        /* SHOP */
        .shop-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .shop-item {
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .shop-item:hover:not(.cant-afford):not(.already-bought) {
            border-color: var(--gold);
            background: var(--gold-dim);
        }

        .shop-item.cant-afford { opacity: 0.4; cursor: not-allowed; }
        .shop-item.already-bought { opacity: 0.35; cursor: not-allowed; border-style: dashed; }

        .shop-item-icon {
            flex-shrink: 0;
            width: 40px;
            text-align: center;
            font-family: 'DM Mono', monospace;
            font-weight: 700;
            font-size: 13px;
            color: var(--gold);
            letter-spacing: -1px;
        }

        .shop-item-icon.emoji-icon {
            font-size: 26px;
            font-family: inherit;
            letter-spacing: 0;
        }

        .shop-item-body { flex: 1; display: flex; flex-direction: column; gap: 3px; }

        .shop-item-name {
            font-family: 'Playfair Display', serif;
            font-size: 15px;
            font-weight: 700;
            color: var(--text);
        }

        .shop-item-desc {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .shop-item-price {
            font-family: 'DM Mono', monospace;
            font-size: 15px;
            font-weight: 700;
            color: var(--gold);
            flex-shrink: 0;
        }

        .coins-display {
            font-family: 'Playfair Display', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--gold);
        }

        /* ---- BOSS INDICATOR ---- */
        .boss-indicator {
            font-family: 'DM Mono', monospace;
            font-size: 10px;
            letter-spacing: 3px;
            color: var(--red);
            text-transform: uppercase;
            padding: 4px 12px;
            border: 1px solid rgba(224,82,82,0.3);
            border-radius: 20px;
            background: rgba(224,82,82,0.05);
        }

        /* ---- GAME OVER / WIN ---- */
        .big-emoji {
            font-size: 56px;
            line-height: 1;
        }

        .result-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .result-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }

        .result-stat-row span:last-child {
            font-family: 'DM Mono', monospace;
            color: var(--gold);
        }

        /* ---- DISCARD MODE HINT ---- */
        .discard-hint {
            font-family: 'DM Mono', monospace;
            font-size: 10px;
            color: var(--red);
            letter-spacing: 2px;
            opacity: 0;
            transition: opacity 0.3s;
            height: 16px;
        }
        .discard-hint.visible { opacity: 1; }

        .tile.wildcard {
            border-color: var(--neon, #a78bfa);
            color: #a78bfa;
            background: rgba(167,139,250,0.08);
            font-size: 32px;
        }
        .tile.wildcard .tile-val {
            color: #a78bfa;
        }
        .tile.wildcard.selected {
            border-color: #a78bfa;
            background: rgba(167,139,250,0.2);
            color: #a78bfa;
            box-shadow: 0 12px 24px rgba(167,139,250,0.25);
        }

        /* ---- LETTER PICKER ---- */
        #letter-picker {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.75);
            z-index: 300;
            align-items: flex-end;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        #letter-picker.active { display: flex; }

        .picker-box {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px 16px 0 0;
            padding: 16px 14px 24px;
            width: 100%;
            max-width: 520px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            animation: slideUp 0.2s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .picker-title {
            font-family: 'Playfair Display', serif;
            font-size: 15px;
            font-weight: 700;
            color: #a78bfa;
        }

        .picker-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 5px;
            width: 100%;
        }

        .picker-letter {
            font-family: 'Playfair Display', serif;
            font-size: 16px;
            font-weight: 700;
            aspect-ratio: 1;
            background: var(--surface2);
            border: 1px solid var(--border);
            border-radius: 7px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text);
            transition: all 0.1s;
            position: relative;
        }

        .picker-letter .pl-val {
            font-family: 'DM Mono', monospace;
            font-size: 7px;
            color: var(--text-dim);
            margin-top: 1px;
        }

        .picker-letter:hover {
            border-color: #a78bfa;
            background: rgba(167,139,250,0.15);
            color: #a78bfa;
        }

        .picker-cancel {
            font-family: 'DM Mono', monospace;
            font-size: 10px;
            letter-spacing: 2px;
            color: var(--text-muted);
            background: transparent;
            border: 1px solid var(--border);
            padding: 6px 20px;
            border-radius: 6px;
            cursor: pointer;
        }
        .picker-cancel:hover { border-color: var(--red); color: var(--red); }
        .score-pop {
            position: fixed;
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            font-weight: 900;
            color: var(--gold-light);
            pointer-events: none;
            z-index: 200;
            animation: scorePop 1.2s ease forwards;
        }
        @keyframes scorePop {
            0% { transform: translateY(0) scale(0.8); opacity: 1; }
            100% { transform: translateY(-80px) scale(1.1); opacity: 0; }
        }

        /* ---- TILE STATES ---- */
        .tile.burned {
            border-color: var(--red);
            background: rgba(240,112,112,0.12);
            animation: burnPulse 1.5s ease-in-out infinite;
        }
        .tile.burned .tile-val { color: var(--red); }

        @keyframes burnPulse {
            0%, 100% { box-shadow: 0 0 6px rgba(240,112,112,0.3); }
            50% { box-shadow: 0 0 16px rgba(240,112,112,0.6); }
        }

        .tile.cursed-tile {
            border-color: #8b5cf6;
            background: rgba(139,92,246,0.1);
            opacity: 0.7;
        }

        .tile.letter-day {
            border-color: #fbbf24;
            box-shadow: 0 0 8px rgba(251,191,36,0.3);
        }
        .tile.letter-day .tile-val { color: #fbbf24; }

        .tile.cincel-ready {
            border-color: #e8c46a;
            border-style: dashed;
            cursor: crosshair;
        }
        .tile.cincel-ready:hover {
            background: rgba(232,196,106,0.15);
            transform: translateY(-4px);
        }

        .word-letter.pos-boosted {
            border-color: #a78bfa;
            background: rgba(167,139,250,0.15);
        }

        /* ---- BUFF BAR ---- */
        .buff-tag {
            font-family: 'DM Mono', monospace;
            font-size: 10px;
            padding: 3px 8px;
            background: rgba(232,196,106,0.1);
            border: 1px solid rgba(232,196,106,0.3);
            border-radius: 20px;
            color: var(--gold);
            white-space: nowrap;
        }

        /* ---- CURSE BAR ---- */
        .curse-tag {
            font-family: 'DM Mono', monospace;
            font-size: 11px;
            padding: 5px 12px;
            background: rgba(240,112,112,0.1);
            border: 1px solid rgba(240,112,112,0.4);
            border-radius: 20px;
            color: var(--red);
            white-space: nowrap;
        }

        /* ---- CINCEL BUTTON ---- */
        .btn-cincel {
            background: transparent;
            color: var(--gold);
            border-color: rgba(232,196,106,0.4);
            font-size: 11px;
            padding: 7px 14px;
        }
        .btn-cincel:hover:not(:disabled) {
            background: rgba(232,196,106,0.1);
            border-color: var(--gold);
        }
        .btn-cincel.active {
            background: rgba(232,196,106,0.15);
            border-color: var(--gold);
        }

        .cincel-hint {
            color: var(--gold) !important;
        }

        /* ---- COIN BREAKDOWN ---- */
        .coin-breakdown {
            width: 100%;
            background: var(--surface2);
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .coin-row {
            display: flex;
            justify-content: space-between;
            font-family: 'DM Mono', monospace;
            font-size: 12px;
            color: var(--text-muted);
        }
        .coin-row.total {
            border-top: 1px solid var(--border);
            padding-top: 6px;
            margin-top: 2px;
            color: var(--gold);
            font-size: 14px;
        }

        /* ---- BOSS CURSE LIST ---- */
        .boss-curse-item {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            background: rgba(240,112,112,0.08);
            border: 1px solid rgba(240,112,112,0.25);
            border-radius: 8px;
            padding: 12px;
        }
        .boss-curse-emoji { font-size: 22px; }
        .boss-curse-name {
            font-family: 'Playfair Display', serif;
            font-size: 14px;
            font-weight: 700;
            color: var(--red);
            margin-bottom: 3px;
        }
        .boss-curse-desc {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }



        /* ---- RESPONSIVE ---- */
        @media (max-width: 600px) {
            .tile { width: 52px; height: 64px; font-size: 22px; }
            .word-letter { width: 42px; height: 50px; font-size: 28px; }
            .hud { gap: 14px; padding: 10px 14px; }
            .hud-value { font-size: 18px; }
        }
    </style>
</head>
<body>

<!-- ======== START SCREEN ======== -->
<div id="screen-start" class="screen active">
    <div class="logo">
        <div class="logo-title">PalabraRogue</div>
        <div class="logo-sub">Juego de palabras ¬∑ Roguelike</div>
    </div>
    <div class="start-info">
        Forma palabras con tus letras<br>
        Supera el objetivo de cada ronda<br>
        Compra mejoras y avanza hacia el jefe
    </div>
    <button class="start-btn" onclick="startGame()">Comenzar</button>
    <div style="display:flex;gap:8px;align-items:center;width:100%;max-width:340px;">
        <input id="seed-input" type="text" placeholder="C√≥digo de partida guardada..." style="flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:10px 12px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;letter-spacing:1px;outline:none;" />
        <button class="btn" style="white-space:nowrap;padding:10px 14px;font-size:12px;" onclick="tryLoadSeed()">‚ñ∂ Cargar</button>
    </div>
    <div id="load-status" style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text-dim);letter-spacing:2px;"></div>
</div>

<!-- ======== GAME SCREEN ======== -->
<div id="screen-game" class="screen">

    <!-- HUD -->
    <div class="hud">
        <!-- Fila 1: stats -->
        <div class="hud-top">
            <div class="hud-section">
                <div class="hud-label">Puntos</div>
                <div class="hud-value" id="hud-score">0</div>
            </div>
            <div class="hud-section">
                <div class="hud-label">Jugadas</div>
                <div class="hud-value red" id="hud-attempts">5</div>
            </div>
            <div class="hud-section">
                <div class="hud-label">Monedas</div>
                <div class="hud-value green" id="hud-coins">0</div>
            </div>
            <button class="btn-exit-hud" onclick="showExitModal()" title="Salir">‚úï</button>
        </div>
        <!-- Fila 2: barra de progreso -->
        <div class="hud-bottom">
            <div class="hud-progress-labels">
                <span id="hud-round">Nivel 1 ¬∑ Ronda 1/3</span>
                <span><span id="hud-prog-cur">0</span> / <span id="hud-prog-goal">50</span> pts</span>
            </div>
            <div class="progress-bar-outer">
                <div class="progress-bar-inner" id="hud-bar" style="width:0%"></div>
            </div>
        </div>
    </div>

    <!-- GAME BODY -->
    <div class="game-body">

        <!-- BOSS ROW: indicator + curses in one line -->
        <div id="boss-row" style="display:none;width:100%;align-items:center;gap:8px;flex-wrap:wrap;justify-content:center;">
            <div class="boss-indicator" id="boss-indicator">‚öî JEFE</div>
            <div id="curse-bar" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
        </div>

        <!-- BUFF BAR -->
        <div id="buff-bar" style="display:none;flex-wrap:wrap;gap:6px;width:100%;justify-content:center;"></div>

        <!-- WORD AREA -->
        <div class="word-area">
            <div class="word-display" id="word-display">
                <div class="word-placeholder">selecciona letras de tu mano</div>
            </div>
            <div class="word-score-preview" id="word-score-preview"></div>
            <div class="feedback" id="feedback"></div>
            <div class="word-actions">
                <button class="btn btn-clear" id="btn-clear" onclick="clearWord()" disabled>Limpiar</button>
                <button class="btn btn-play" id="btn-play" onclick="playWord()" disabled>Jugar</button>
            </div>
        </div>

        <!-- HAND -->
        <div class="hand-section">
            <div class="hand-label">Tu mano</div>
            <div class="hand" id="hand"></div>
            <div class="discard-hint" id="discard-hint">SELECCIONA LETRAS A DESCARTAR</div>
            <div class="discard-hint cincel-hint" id="cincel-hint">üî® SELECCIONA LA LETRA A SUSTITUIR</div>
            <div class="hand-controls">
                <button class="btn btn-hand" onclick="shuffleHand()">‚ü≥ Revolver</button>
                <button id="btn-cincel" class="btn btn-cincel" onclick="toggleCincelMode()" style="display:none">üî® Cincel</button>
                <button class="btn btn-discard-mode" id="btn-discard" onclick="toggleDiscardMode()">‚úï Descartar</button>
                <span class="counter-badge" id="discard-count"></span>
            </div>
            <div class="bag-info" id="bag-info"></div>
        </div>

        <!-- LOG -->
        <div class="log" id="log"></div>

    </div>
</div>

<!-- ======== MODAL: ROUND WIN ======== -->
<div class="modal-overlay" id="modal-round-win">
    <div class="modal">
        <div class="big-emoji">‚ú®</div>
        <div class="modal-title" id="rw-title">¬°Ronda Superada!</div>
        <div class="modal-sub" id="rw-sub">Has alcanzado el objetivo</div>
        <div class="modal-stat"><div class="modal-stat-label">Puntos:</div><div class="modal-stat-val" id="rw-score">0</div></div>

        <div id="rw-coins" class="coin-breakdown"></div>
        <button class="btn btn-play" onclick="goToShop()" style="margin-top:8px">Ir a la Tienda ‚Üí</button>
    </div>
</div>

<!-- ======== MODAL: SHOP ======== -->
<div class="modal-overlay" id="modal-shop">
    <div class="modal">
        <div class="modal-title">Tienda</div>
        <div class="modal-sub" id="shop-sub">Siguiente: Nivel 1 ¬∑ Ronda 2</div>
        <div style="display:flex;gap:8px;align-items:center">
            <div class="modal-stat-label">Tus monedas:</div>
            <div class="coins-display" id="shop-coins">0 ü™ô</div>
        </div>
        <div class="shop-grid" id="shop-grid"></div>
        <button class="btn btn-play" onclick="nextRound()">Continuar ‚Üí</button>
    </div>
</div>

<!-- ======== MODAL: BOSS INTRO ======== -->
<div class="modal-overlay" id="modal-boss-intro">
    <div class="modal">
        <div class="big-emoji">‚öîÔ∏è</div>
        <div class="modal-title">¬°Aparece el Jefe!</div>
        <div class="modal-sub" id="boss-intro-level">Nivel 1 ¬∑ Objetivo: 50 pts</div>
        <div style="width:100%">
            <div style="font-family:'DM Mono',monospace;font-size:11px;letter-spacing:3px;color:var(--text-dim);margin-bottom:12px;text-transform:uppercase">Maldiciones activas</div>
            <div id="boss-curse-list" style="display:flex;flex-direction:column;gap:10px;width:100%"></div>
        </div>
        <button class="btn btn-play" onclick="startBossFight()" style="margin-top:8px;background:var(--red);border-color:var(--red)">¬°Luchar!</button>
    </div>
</div>

<!-- ======== MODAL: GAME OVER ======== -->
<!-- ======== MODAL: EXIT ======== -->
<div class="modal-overlay" id="modal-exit">
    <div class="modal">
        <div class="modal-title">Pausar</div>
        <div class="modal-sub">¬øQu√© quieres hacer?</div>
        <div style="width:100%;display:flex;flex-direction:column;gap:10px;">
            <button class="btn btn-play" onclick="hideAllModals()">‚Ü© Volver a la partida</button>
            <button class="btn" style="border-color:var(--gold);color:var(--gold)" onclick="showSaveSeed()">üíæ Guardar partida</button>
            <button class="btn" style="border-color:var(--red);color:var(--red)" onclick="confirmSurrender()">üè≥ Rendirse</button>
        </div>
        <div id="save-seed-area" style="display:none;width:100%;text-align:center">
            <div style="font-family:'DM Mono',monospace;font-size:11px;color:var(--text-muted);letter-spacing:2px;margin-bottom:8px">C√ìDIGO DE PARTIDA</div>
            <div id="seed-display" style="font-family:'DM Mono',monospace;font-size:14px;color:var(--gold);background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px;word-break:break-all;letter-spacing:1px"></div>
            <div style="font-size:11px;color:var(--text-dim);margin-top:8px">Copia este c√≥digo. En el men√∫ principal podr√°s continuar.</div>
            <button class="btn" style="margin-top:8px;font-size:11px" onclick="copySeed()">üìã Copiar c√≥digo</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-gameover">
    <div class="modal">
        <div class="big-emoji">üíÄ</div>
        <div class="modal-title">Derrota</div>
        <div class="modal-sub">Se acabaron los intentos</div>
        <div class="result-stats" id="gameover-stats"></div>
        <button class="btn btn-play" onclick="resetGame()">Volver a intentarlo</button>
    </div>
</div>

<!-- ======== MODAL: VICTORY ======== -->
<div class="modal-overlay" id="modal-victory">
    <div class="modal">
        <div class="big-emoji">üèÜ</div>
        <div class="modal-title">¬°Victoria!</div>
        <div class="modal-sub">Has completado todos los niveles</div>
        <div class="result-stats" id="victory-stats"></div>
        <button class="btn btn-play" onclick="resetGame()">Jugar de nuevo</button>
    </div>
</div>

<!-- ======== LETTER PICKER (comod√≠n) ======== -->
<div id="letter-picker">
    <div class="picker-box">
        <div class="picker-title" id="picker-title">‚ú¶ Elige una letra para el comod√≠n</div>
        <div class="picker-grid" id="picker-grid"></div>
        <button class="picker-cancel" onclick="closePicker()">Cancelar</button>
    </div>
</div>

<script>
// ============================================================
//  CONFIGURACI√ìN
// ============================================================
const CONFIG = {
    HAND_SIZE: 7,
    BAG_SIZE: 100,
    MAX_ROUNDS: 3,
    MAX_LEVELS: 3,
    BASE_JUGADAS: 5,
    BASE_DISCARDS: 4,
    MAX_HAND: 12,
    MAX_JUGADAS: 8,
    MAX_DISCARDS: 8,
    roundGoal: (level, round, isBoss) => {
        // Con nuevo sistema: palabra 4 letras ~17pts, 5 letras ~26pts, 6 letras ~37pts
        // 5 jugadas por ronda ‚Üí potencial ~85-185 pts por ronda
        const goals = [
            [50,  80,  110, 160],   // nivel 1
            [150, 200, 260, 350],   // nivel 2
            [320, 400, 490, 650],   // nivel 3
        ];
        const lvl = goals[Math.min(level - 1, goals.length - 1)];
        return isBoss ? lvl[3] : lvl[Math.min(round - 1, 2)];
    },
};

// ============================================================
//  LETRAS
// ============================================================
const LETTER_POOL = [
    ...Array(12).fill('A'), ...Array(12).fill('E'), ...Array(9).fill('O'),
    ...Array(6).fill('I'),  ...Array(6).fill('U'),
    ...Array(6).fill('S'),  ...Array(5).fill('N'), ...Array(5).fill('R'),
    ...Array(5).fill('L'),  ...Array(4).fill('T'), ...Array(4).fill('D'),
    ...Array(3).fill('C'),  ...Array(3).fill('M'), ...Array(3).fill('P'),
    ...Array(2).fill('B'),  ...Array(2).fill('G'), ...Array(2).fill('V'),
    ...Array(2).fill('F'),  ...Array(2).fill('H'), ...Array(2).fill('Y'),
    ...Array(1).fill('J'),  ...Array(2).fill('√ë'), ...Array(1).fill('Q'),
    ...Array(1).fill('X'),  ...Array(1).fill('Z'), ...Array(1).fill('W'),
    ...Array(1).fill('K'),  ...Array(3).fill('*'),
];

const LETTER_VALUES = {
    A:1,E:1,O:1,I:1,U:1,S:1,N:1,R:1,L:1,T:1,
    D:2,G:2, B:3,C:3,M:3,P:3, F:4,H:4,V:4,Y:4,
    J:6,√ë:6,X:6, K:8,W:8,Z:8, Q:10
};

const ALL_LETTERS = ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','√ë','O','P','Q','R','S','T','U','V','W','X','Y','Z'];
const VOWELS = new Set(['A','E','I','O','U']);

// ============================================================
//  MEJORAS DE TIENDA
// ============================================================
const SHOP_ITEMS = [
    // --- COMUNES (weight 4) ---
    {
        id: 'bag_extra', name: 'Bolsa Extra', emoji: 'üéí',
        desc: 'A√±ade 30 letras m√°s a tu bolsa ahora mismo.',
        price: 3, weight: 4,
        canBuy: gs => true,
        apply: gs => {
            const extra = shuffleArr([...LETTER_POOL]).slice(0, 30);
            gs.bag.push(...extra);
        }
    },
    {
        id: 'recycle_extra', name: 'Reciclaje Extra', emoji: '‚ôªÔ∏è',
        desc: '+1 descarte permanente. M√°ximo 5 descartes en total.',
        price: 2, weight: 4,
        canBuy: gs => gs.upgrades.extraDiscards < 4,
        apply: gs => gs.upgrades.extraDiscards++
    },
    {
        id: 'round_extra', name: 'Ronda Extra', emoji: 'üÉè',
        desc: '+1 jugada durante este nivel (hasta vencer al jefe). M√°ximo 8.',
        price: 2, weight: 4,
        canBuy: gs => gs.levelBonuses.extraJugadas < 3,
        apply: gs => gs.levelBonuses.extraJugadas++
    },
    // --- POCO COMUNES (weight 3) ---
    {
        id: 'hand_large', name: 'Mano Grande', emoji: '‚úã',
        desc: '+1 letra en mano de forma permanente. Acumulable hasta 12 letras.',
        price: 4, weight: 3,
        canBuy: gs => gs.upgrades.handBonus < 5,
        apply: gs => gs.upgrades.handBonus++
    },
    {
        id: 'eco_discard', name: 'Econom√≠a de Descarte', emoji: 'üíé',
        desc: 'Los descartes sin usar generan +2ü™ô cada uno al final de ronda.',
        price: 3, weight: 3,
        canBuy: gs => !gs.upgrades.discardEconomy,
        apply: gs => gs.upgrades.discardEconomy = true
    },
    {
        id: 'eco_play', name: 'Econom√≠a de Jugadas', emoji: 'üíé',
        desc: 'Las jugadas sin usar valen el doble de monedas al final de ronda.',
        price: 3, weight: 3,
        canBuy: gs => !gs.upgrades.playEconomy,
        apply: gs => gs.upgrades.playEconomy = true
    },
    {
        id: 'pos1', name: 'Posici√≥n [1] √ó2', emoji: '[1]',
        desc: 'La letra en la 1¬™ posici√≥n de la palabra vale el doble.',
        price: 3, weight: 3,
        canBuy: gs => !gs.upgrades.posDouble.includes(0),
        apply: gs => gs.upgrades.posDouble.push(0)
    },
    {
        id: 'pos2', name: 'Posici√≥n [2] √ó2', emoji: '[2]',
        desc: 'La letra en la 2¬™ posici√≥n de la palabra vale el doble.',
        price: 3, weight: 3,
        canBuy: gs => !gs.upgrades.posDouble.includes(1),
        apply: gs => gs.upgrades.posDouble.push(1)
    },
    {
        id: 'pos3', name: 'Posici√≥n [3] √ó2', emoji: '[3]',
        desc: 'La letra en la 3¬™ posici√≥n de la palabra vale el doble.',
        price: 3, weight: 3,
        canBuy: gs => !gs.upgrades.posDouble.includes(2),
        apply: gs => gs.upgrades.posDouble.push(2)
    },
    {
        id: 'pos4', name: 'Posici√≥n [4] √ó2', emoji: '[4]',
        desc: 'La letra en la 4¬™ posici√≥n de la palabra vale el doble.',
        price: 3, weight: 3,
        canBuy: gs => !gs.upgrades.posDouble.includes(3),
        apply: gs => gs.upgrades.posDouble.push(3)
    },
    {
        id: 'pos5', name: 'Posici√≥n [5] √ó2', emoji: '[5]',
        desc: 'La letra en la 5¬™ posici√≥n de la palabra vale el doble.',
        price: 3, weight: 3,
        canBuy: gs => !gs.upgrades.posDouble.includes(4),
        apply: gs => gs.upgrades.posDouble.push(4)
    },
    {
        id: 'pos6', name: 'Posici√≥n [6] √ó2', emoji: '[6]',
        desc: 'La letra en la 6¬™ posici√≥n de la palabra vale el doble.',
        price: 3, weight: 3,
        canBuy: gs => !gs.upgrades.posDouble.includes(5),
        apply: gs => gs.upgrades.posDouble.push(5)
    },
    {
        id: 'pos7', name: 'Posici√≥n [7] √ó2', emoji: '[7]',
        desc: 'La letra en la 7¬™ posici√≥n exacta de la palabra vale el doble.',
        price: 3, weight: 3,
        canBuy: gs => !gs.upgrades.posDouble.includes(6),
        apply: gs => gs.upgrades.posDouble.push(6)
    },
    {
        id: 'shop_size', name: 'Tama√±o de Tienda', emoji: 'üè™',
        desc: 'La tienda ofrece 4 mejoras en lugar de 3. Permanente.',
        price: 10, weight: 2,
        canBuy: gs => !gs.upgrades.shopSize,
        apply: gs => gs.upgrades.shopSize = true
    },
    {
        id: 'value_boost', name: 'Valor Mejorado', emoji: '‚¨ÜÔ∏è',
        desc: 'Todas las letras que val√≠an 1 punto ahora valen 2. Permanente.',
        price: 6, weight: 2,
        canBuy: gs => !gs.upgrades.valueBoost,
        apply: gs => gs.upgrades.valueBoost = true
    },
    {
        id: 'cincel', name: 'Cincel', emoji: 'üî®',
        desc: 'Cambia cualquier letra de tu mano por la que elijas. 1 uso.',
        price: 5, weight: 2,
        canBuy: gs => true,
        apply: gs => gs.upgrades.cincelUses++
    },
    {
        id: 'letter_day', name: 'Letra del D√≠a', emoji: '‚≠ê',
        desc: 'Una letra aleatoria vale √ó3 durante este nivel. Acumulable.',
        price: 5, weight: 2,
        canBuy: gs => gs.levelBonuses.letterOfDay.length < ALL_LETTERS.length,
        apply: gs => {
            const used = gs.levelBonuses.letterOfDay.map(l => l.letter);
            const avail = ALL_LETTERS.filter(l => !used.includes(l));
            if (avail.length > 0) {
                const letter = avail[Math.floor(Math.random() * avail.length)];
                gs.levelBonuses.letterOfDay.push({ letter, mult: 3 });
            }
        }
    },
    {
        id: 'pos123', name: 'Posici√≥n [1][2][3] √ó2', emoji: 'üéØ',
        desc: 'Las letras en las posiciones 1, 2 y 3 valen el doble.',
        price: 8, weight: 2,
        canBuy: gs => ![0,1,2].every(p => gs.upgrades.posDouble.includes(p)),
        apply: gs => { [0,1,2].forEach(p => { if (!gs.upgrades.posDouble.includes(p)) gs.upgrades.posDouble.push(p); }); }
    },
    {
        id: 'pos456', name: 'Posici√≥n [4][5][6] √ó2', emoji: 'üéØ',
        desc: 'Las letras en las posiciones 4, 5 y 6 valen el doble.',
        price: 8, weight: 2,
        canBuy: gs => ![3,4,5].every(p => gs.upgrades.posDouble.includes(p)),
        apply: gs => { [3,4,5].forEach(p => { if (!gs.upgrades.posDouble.includes(p)) gs.upgrades.posDouble.push(p); }); }
    },
    {
        id: 'pos7etc', name: 'Posici√≥n [7+] √ó2', emoji: 'üéØ',
        desc: 'Todas las letras en posici√≥n 7 o m√°s valen el doble.',
        price: 6, weight: 2,
        canBuy: gs => !gs.upgrades.posFrom7,
        apply: gs => gs.upgrades.posFrom7 = true
    },
];

// ============================================================
//  MALDICIONES DE JEFES
// ============================================================
// weight: [nivel1, nivel2, nivel3] ‚Äî 0 = nunca aparece
const BOSS_CURSES = [
    {
        id: 'short_cursed',
        name: 'Palabras Cortas Malditas',
        emoji: 'üíÄ',
        desc: 'Las palabras de 4 letras o menos no dan puntos.',
        weight: [4, 3, 2],
        apply: gs => gs.curses.shortWordsCursed = true
    },
    {
        id: 'vowels_cursed',
        name: 'Vocales Malditas',
        emoji: 'üîá',
        desc: 'Las vocales punt√∫an 0 durante este combate.',
        weight: [2, 3, 4],
        apply: gs => gs.curses.vocalsCursed = true
    },
    {
        id: 'odd_cursed',
        name: 'Impares Malditas',
        emoji: 'üîÆ',
        desc: 'Las palabras con n√∫mero impar de letras no punt√∫an.',
        weight: [3, 3, 3],
        apply: gs => gs.curses.oddCursed = true
    },
    {
        id: 'even_cursed',
        name: 'Pares Malditas',
        emoji: 'üîÆ',
        desc: 'Las palabras con n√∫mero par de letras no punt√∫an.',
        weight: [3, 3, 3],
        apply: gs => gs.curses.evenCursed = true
    },
    {
        id: 'letters_cursed',
        name: 'Letras Malditas',
        emoji: '‚ò†Ô∏è',
        desc: '2 letras aleatorias de tu mano punt√∫an 0.',
        weight: [4, 4, 3],
        apply: gs => {
            const letters = gs.hand.filter(t => t.letter && t.letter !== '*').map(t => t.letter);
            const unique = [...new Set(letters)];
            const shuffled = shuffleArr(unique);
            gs.curses.cursedLetters = shuffled.slice(0, 2);
        }
    },
    {
        id: 'only_short',
        name: 'Palabras Cortas',
        emoji: '‚úÇÔ∏è',
        desc: 'Solo cuentan palabras de 4 letras o menos.',
        weight: [3, 1, 0],
        apply: gs => gs.curses.onlyShort = true
    },
    {
        id: 'no_discards',
        name: 'Sin Descartes',
        emoji: 'üö´',
        desc: 'No puedes descartar letras durante este combate.',
        weight: [4, 3, 2],
        apply: gs => gs.curses.noDiscards = true
    },
    {
        id: 'burned_hand',
        name: 'Mano Quemada',
        emoji: 'üî•',
        desc: '2 letras en tu mano est√°n quemadas y punt√∫an 0. Cambian tras cada palabra v√°lida.',
        weight: [3, 4, 4],
        apply: gs => refreshBurnedTiles(gs)
    },
];

// ============================================================
//  COMOD√çN ‚Äî PICKER
// ============================================================
let pickerCallback = null;
let cincelMode = false;

function openPicker(tileId, isCincel = false) {
    const grid = document.getElementById('picker-grid');
    grid.innerHTML = '';
    document.getElementById('picker-title').textContent = isCincel
        ? 'üî® Elige la letra que sustituir√° a esta ficha'
        : '‚ú¶ Elige una letra para el comod√≠n';
    ALL_LETTERS.forEach(letter => {
        const div = document.createElement('div');
        div.className = 'picker-letter';
        div.innerHTML = `${letter}<span class="pl-val">${LETTER_VALUES[letter]||1}</span>`;
        div.onclick = () => isCincel ? applyCincel(tileId, letter) : chooseLetter(tileId, letter);
        grid.appendChild(div);
    });
    document.getElementById('letter-picker').classList.add('active');
}

function chooseLetter(tileId, letter) {
    const tile = gameState.hand.find(t => t.id === tileId);
    if (tile) tile.chosenLetter = letter;
    closePicker();
    if (!gameState.selectedIds.includes(tileId)) gameState.selectedIds.push(tileId);
    renderWordDisplay();
    renderHand();
}

function applyCincel(tileId, letter) {
    const gs = gameState;
    const tile = gs.hand.find(t => t.id === tileId);
    if (tile) {
        tile.letter = letter;
        tile.chosenLetter = null;
    }
    gs.upgrades.cincelUses--;
    cincelMode = false;
    closePicker();
    addLog(`Cincel usado: ‚Üí ${letter}`, 'sys');
    renderAll();
}

function closePicker() {
    document.getElementById('letter-picker').classList.remove('active');
}

function effectiveLetter(tile) {
    if (tile.letter === '*') return tile.chosenLetter || '*';
    return tile.letter;
}

// ============================================================
//  HELPERS
// ============================================================
function shuffleArr(arr) {
    const a = [...arr];
    for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
}

function weightedRandom(items, weightFn) {
    const total = items.reduce((s, x) => s + weightFn(x), 0);
    let r = Math.random() * total;
    for (const item of items) {
        r -= weightFn(item);
        if (r <= 0) return item;
    }
    return items[items.length - 1];
}

// ============================================================
//  ESTADO DEL JUEGO
// ============================================================
let dictionary = new Set();
let dictLoaded = false;
let gameState = {};

function freshState() {
    return {
        score: 0,
        coins: 0,
        level: 1,
        round: 1,
        isBoss: false,
        goal: 0,
        jugadas: CONFIG.BASE_JUGADAS,
        jugadasLeft: CONFIG.BASE_JUGADAS,
        discards: CONFIG.BASE_DISCARDS,
        discardsLeft: CONFIG.BASE_DISCARDS,
        bag: [],
        hand: [],
        selectedIds: [],
        discardMode: false,
        totalWords: 0,
        totalScore: 0,
        shopSelection: null,
        shopBoughtIds: [],
        shopVisits: 0,
        // Upgrades permanentes
        upgrades: {
            handBonus: 0,
            valueBoost: false,
            posDouble: [],
            posFrom7: false,
            discardEconomy: false,
            playEconomy: false,
            cincelUses: 0,
            extraDiscards: 0,
            wordLevels: [0, 0, 0, 0, 0, 0],
            shopSize: false,
        },
        // Bonuses de nivel (se resetean al pasar de nivel)
        levelBonuses: {
            letterOfDay: [],
            extraJugadas: 0,
        },
        // Maldiciones (activas solo durante el jefe)
        curses: {
            active: [],
            shortWordsCursed: false,
            vocalsCursed: false,
            oddCursed: false,
            evenCursed: false,
            cursedLetters: [],
            onlyShort: false,
            noDiscards: false,
            burnedIds: [],
        },
    };
}

// ============================================================
//  NORMALIZACI√ìN
// ============================================================
function normalizeWord(word) {
    return word.toUpperCase()
        .replace(/√ë/g, '\x00')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/\x00/g, '√ë');
}

// ============================================================
//  DICCIONARIO
// ============================================================
async function loadDictionary() {
    document.getElementById('load-status').textContent = 'Cargando diccionario...';
    try {
        let res = await fetch('Diccionario.txt');
        if (!res.ok) res = await fetch('diccionario.txt');
        if (!res.ok) throw new Error('no encontrado');
        const text = await res.text();
        const words = text.split(/\r?\n/).map(w => normalizeWord(w.trim())).filter(w => w.length >= 2);
        dictionary = new Set(words);
        dictLoaded = true;
        document.getElementById('load-status').textContent = `‚úì ${dictionary.size.toLocaleString()} palabras cargadas`;
    } catch(e) {
        const sample = ['CASA','MESA','SILLA','LIBRO','AGUA','FUEGO','TIERRA','AIRE',
            'SOL','LUNA','MAR','RIO','MONTE','CAMPO','CALLE','CIUDAD',
            'AMOR','VIDA','TIEMPO','MUNDO','MANO','OJO','CARA','PIE',
            'GATO','PERRO','PATO','TORO','LOBO','RANA','VACA','PAN',
            'SAL','VINO','LECHE','CARNE','SOPA','ARROZ','ROJO','AZUL',
            'VERDE','BLANCO','NEGRO','UNO','DOS','TRES','SEIS','OCHO',
            'SER','ESTAR','TENER','PODER','HACER','VER','DAR','SALA',
            'ISLA','PLAYA','LAGO','BOSQUE','VALLE','TREN','MOTO','REY',
            'REINA','ESPADA','LANZA','ARCO','ORO','PLATA','PIEDRA',
            'LETRA','PALABRA','JUEGO','RONDA','TURNO','PUNTO','TORRE',
            'LLAVE','VIENTO','LLUVIA','NIEVE','HIELO','CIELO','LUZ'];
        dictionary = new Set(sample.map(w => w.toUpperCase()));
        dictLoaded = true;
        document.getElementById('load-status').textContent = '‚ö† Diccionario de prueba';
    }
}

function isValidWord(word) {
    return word.length >= 2 && dictionary.has(normalizeWord(word));
}

// ============================================================
//  C√ìDIGO KONAMI ‚Äî MODO DIOS
// ============================================================
const KONAMI = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
let konamiIdx = 0;
let godMode = false;

document.addEventListener('keydown', e => {
    if (e.key === KONAMI[konamiIdx]) {
        konamiIdx++;
        if (konamiIdx === KONAMI.length) { konamiIdx = 0; toggleGodMode(); }
    } else {
        konamiIdx = e.key === KONAMI[0] ? 1 : 0;
    }
});

function toggleGodMode() {
    godMode = !godMode;
    if (godMode) showGodPanel(); else closeGodPanel();
}

function showGodPanel() {
    let panel = document.getElementById('god-panel');
    if (!panel) {
        panel = document.createElement('div');
        panel.id = 'god-panel';
        panel.style.cssText = `position:fixed;bottom:20px;right:20px;z-index:9999;background:#1a1030;border:2px solid #a78bfa;border-radius:14px;padding:20px;min-width:240px;font-family:'DM Mono',monospace;font-size:12px;box-shadow:0 0 30px rgba(167,139,250,0.4);color:#e0d0ff;`;
        panel.innerHTML = `<div style="font-size:14px;font-weight:700;color:#a78bfa;margin-bottom:14px;letter-spacing:2px">‚ö° MODO DIOS</div>
            <div style="display:flex;flex-direction:column;gap:8px;">
                <button onclick="godWinRound()" style="${godBtnStyle()}">‚úì Ganar ronda</button>
                <button onclick="godMaxScore()" style="${godBtnStyle()}">‚òÖ Puntos m√°ximos</button>
                <button onclick="godGotoLevel(1)" style="${godBtnStyle()}">‚ë† Ir a Nivel 1</button>
                <button onclick="godGotoLevel(2)" style="${godBtnStyle()}">‚ë° Ir a Nivel 2</button>
                <button onclick="godGotoLevel(3)" style="${godBtnStyle()}">‚ë¢ Ir a Nivel 3</button>
                <button onclick="godGotoBoss()" style="${godBtnStyle()}">‚öî Ir al Jefe actual</button>
                <button onclick="godAddCoins()" style="${godBtnStyle()}">ü™ô +20 monedas</button>
                <button onclick="closeGodPanel()" style="${godBtnStyle('close')}">‚úï Cerrar</button>
            </div>`;
        document.body.appendChild(panel);
    } else { panel.style.display = 'block'; }
}
function godBtnStyle(type) {
    const base = 'background:#2a1a4a;border:1px solid #a78bfa;color:#e0d0ff;padding:7px 12px;border-radius:6px;cursor:pointer;font-family:DM Mono,monospace;font-size:11px;letter-spacing:1px;transition:all 0.15s;width:100%;text-align:left;';
    return type === 'close' ? base + 'border-color:#f07070;color:#f07070;' : base;
}
function closeGodPanel() { godMode = false; const p = document.getElementById('god-panel'); if (p) p.style.display = 'none'; }
function godWinRound() { if (document.getElementById('screen-game').classList.contains('active')) { gameState.score = gameState.goal; renderHUD(); setTimeout(roundWin, 200); } }
function godMaxScore() { if (document.getElementById('screen-game').classList.contains('active')) { gameState.score = gameState.goal * 2; renderHUD(); addLog('‚ö° GOD MODE: puntos m√°ximos', 'sys'); } }
function godGotoLevel(lvl) { hideAllModals(); gameState.level = lvl; gameState.round = 1; gameState.isBoss = false; gameState.bag = []; gameState.coins = 10; gameState.levelBonuses = { letterOfDay: [], extraJugadas: 0 }; initRound(); showScreen('game'); addLog(`‚ö° GOD MODE: Nivel ${lvl}`, 'sys'); }
function godGotoBoss() { hideAllModals(); gameState.round = CONFIG.MAX_ROUNDS + 1; gameState.isBoss = true; gameState.bag = gameState.bag.length < 20 ? buildBag() : gameState.bag; initRound(); showScreen('game'); addLog('‚ö° GOD MODE: Ronda Jefe', 'sys'); }
function godAddCoins() { gameState.coins += 20; renderHUD(); const el = document.getElementById('shop-coins'); if (el) el.textContent = `${gameState.coins} ü™ô`; addLog('‚ö° GOD MODE: +20 monedas', 'sys'); }

// ============================================================
//  INICIO / RESET
// ============================================================
async function startGame() {
    if (!dictLoaded) await loadDictionary();
    gameState = freshState();
    initRound();
    showScreen('game');
}

async function tryLoadSeed() {
    const seed = document.getElementById('seed-input').value.trim();
    if (!seed) return;
    if (!dictLoaded) await loadDictionary();
    const ok = loadSeed(seed);
    if (!ok) {
        document.getElementById('load-status').textContent = '‚ö† C√≥digo inv√°lido';
        document.getElementById('load-status').style.color = 'var(--red)';
    }
}

function resetGame() { hideAllModals(); showScreen('start'); }

function showScreen(name) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-' + name).classList.add('active');
}

// ============================================================
//  BOLSA & MANO
// ============================================================
function buildBag() {
    return shuffleArr([...LETTER_POOL]).slice(0, CONFIG.BAG_SIZE);
}

function drawFromBag(n) {
    const drawn = [];
    for (let i = 0; i < n && gameState.bag.length > 0; i++) drawn.push(gameState.bag.pop());
    return drawn;
}

function fillHand() {
    const gs = gameState;
    const empty = gs.hand.filter(t => t.letter === null).length;
    const drawn = drawFromBag(Math.min(empty, gs.bag.length));
    let di = 0;
    for (let i = 0; i < gs.hand.length && di < drawn.length; i++) {
        if (gs.hand[i].letter === null) gs.hand[i].letter = drawn[di++];
    }
}

let tileIdCounter = 0;
function makeTile(letter) { return { id: tileIdCounter++, letter, chosenLetter: null }; }

// ============================================================
//  MALDICIONES
// ============================================================
function refreshBurnedTiles(gs) {
    const available = gs.hand.filter(t => t.letter && t.letter !== '*');
    const shuffled = shuffleArr(available);
    gs.curses.burnedIds = shuffled.slice(0, 2).map(t => t.id);
}

function clearCurses(gs) {
    gs.curses = {
        active: [],
        shortWordsCursed: false,
        vocalsCursed: false,
        oddCursed: false,
        evenCursed: false,
        cursedLetters: [],
        onlyShort: false,
        noDiscards: false,
        burnedIds: [],
    };
}

function applyBossCurses(gs) {
    clearCurses(gs);
    const level = gs.level;
    const numCurses = level === 3 ? 2 : 1;
    const available = BOSS_CURSES.filter(c => c.weight[level - 1] > 0);
    const selected = [];
    const pool = [...available];
    while (selected.length < numCurses && pool.length > 0) {
        const curse = weightedRandom(pool, c => c.weight[level - 1]);
        selected.push(curse);
        pool.splice(pool.indexOf(curse), 1);
    }
    selected.forEach(curse => {
        gs.curses.active.push(curse.id);
        curse.apply(gs);
    });
}

// ============================================================
//  RONDA
// ============================================================
function initRound() {
    const gs = gameState;
    gs.score = 0;
    gs.isBoss = (gs.round > CONFIG.MAX_ROUNDS);
    gs.goal = CONFIG.roundGoal(gs.level, gs.isBoss ? 4 : gs.round, gs.isBoss);

    // Calcular jugadas y descartes con mejoras
    gs.jugadas = Math.min(CONFIG.MAX_JUGADAS, CONFIG.BASE_JUGADAS + gs.levelBonuses.extraJugadas);
    gs.jugadasLeft = gs.jugadas;
    gs.discards = Math.min(CONFIG.MAX_DISCARDS, CONFIG.BASE_DISCARDS + gs.upgrades.extraDiscards);
    gs.discardsLeft = gs.discards;

    gs.selectedIds = [];
    gs.discardMode = false;
    cincelMode = false;

    // Bolsa fresca cada ronda
    gs.bag = buildBag();

    // Construir mano
    const handSize = CONFIG.HAND_SIZE + gs.upgrades.handBonus;
    gs.hand = Array.from({length: handSize}, () => makeTile(null));
    fillHand();

    // Aplicar maldiciones si es jefe
    if (gs.isBoss) {
        applyBossCurses(gs);
        if (gs.curses.noDiscards) gs.discardsLeft = 0;
    } else {
        clearCurses(gs);
    }

    clearWord();
    renderAll();
    renderCurseBar();
    renderBuffBar();

    if (gs.isBoss && gs.curses.active.length > 0) {
        showBossIntro();
    } else {
        const label = gs.isBoss ? 'JEFE' : `Ronda ${gs.round}`;
        addLog(`${label} ‚Äî Objetivo: ${gs.goal} pts`, 'sys');
    }
}

// Tabla de multiplicador y bonus por longitud de palabra
// ============================================================
//  TABLA DE NIVELES DE PALABRA
//  √çndices: 0=len2, 1=len3, 2=len4, 3=len5, 4=len6, 5=len7+
//  Cada entrada: array de niveles [lvl1, lvl2, lvl3, lvl4, lvl5]
//  Cada nivel: { mult, bonus }
// ============================================================
const WORD_LEVEL_TABLE = [
    // len 2
    [ {mult:1.0,bonus:0}, {mult:1.0,bonus:10}, {mult:1.0,bonus:20}, {mult:2.0,bonus:20}, {mult:2.0,bonus:40} ],
    // len 3
    [ {mult:1.0,bonus:2}, {mult:1.0,bonus:15}, {mult:1.5,bonus:15}, {mult:2.0,bonus:25}, {mult:2.0,bonus:50} ],
    // len 4
    [ {mult:1.5,bonus:5}, {mult:1.5,bonus:18}, {mult:2.0,bonus:18}, {mult:2.5,bonus:30}, {mult:3.0,bonus:50} ],
    // len 5
    [ {mult:2.0,bonus:10}, {mult:2.0,bonus:25}, {mult:2.5,bonus:25}, {mult:3.0,bonus:40}, {mult:3.5,bonus:65} ],
    // len 6
    [ {mult:2.5,bonus:16}, {mult:2.5,bonus:35}, {mult:3.0,bonus:35}, {mult:3.5,bonus:55}, {mult:4.0,bonus:85} ],
    // len 7+
    [ {mult:3.0,bonus:25}, {mult:3.0,bonus:50}, {mult:3.5,bonus:50}, {mult:4.0,bonus:75}, {mult:5.0,bonus:110} ],
];

const WORD_LENGTH_LABELS = ['2 letras','3 letras','4 letras','5 letras','6 letras','7+ letras'];
const WORD_LENGTH_EMOJIS = ['‚ë°','‚ë¢','‚ë£','‚ë§','‚ë•','‚ë¶'];

// Devuelve el √≠ndice de categor√≠a para una longitud dada
function lenIdx(len) {
    if (len <= 2) return 0;
    if (len === 3) return 1;
    if (len === 4) return 2;
    if (len === 5) return 3;
    if (len === 6) return 4;
    return 5;
}

// Devuelve el {mult, bonus} activo para una longitud, teniendo en cuenta el nivel actual
function getWordScore(len) {
    const idx = lenIdx(len);
    const level = gameState.upgrades.wordLevels[idx]; // 0-based
    return WORD_LEVEL_TABLE[idx][level];
}

// Precio de subir al siguiente nivel (sube con el nivel)
function wordUpgradePrice(currentLevel) {
    return [5, 7, 10, 14][currentLevel] || 14;
}

// Genera los shop items de mejora de palabra din√°micamente
function getWordUpgradeItems() {
    const items = [];
    for (let i = 0; i < 6; i++) {
        const currentLvl = gameState.upgrades.wordLevels[i];
        if (currentLvl >= 4) continue; // ya en nivel m√°ximo
        const nextLvl = currentLvl + 1;
        const current = WORD_LEVEL_TABLE[i][currentLvl];
        const next = WORD_LEVEL_TABLE[i][nextLvl];
        const price = wordUpgradePrice(currentLvl);
        items.push({
            id: `word_lvl_${i}`,
            name: `Palabras de longitud ${WORD_LENGTH_LABELS[i]}`,
            emoji: WORD_LENGTH_EMOJIS[i],
            desc: `Sube de Nivel ${currentLvl+1} a Nivel ${nextLvl+1}`,
            price,
            weight: [4, 3, 3, 2][currentLvl],
            isWordUpgrade: true,
            lenIdx: i,
            canBuy: gs => gs.upgrades.wordLevels[i] < 4,
            apply: gs => gs.upgrades.wordLevels[i]++,
        });
    }
    return items;
}

// ============================================================
//  PUNTUACI√ìN CENTRALIZADA
// ============================================================
function calculatePoints(selected) {
    const gs = gameState;
    const len = selected.length;

    // Maldiciones a nivel de palabra
    if (gs.curses.onlyShort && len > 4) return 0;
    if (gs.curses.shortWordsCursed && len <= 4) return 0;
    if (gs.curses.oddCursed && len % 2 !== 0) return 0;
    if (gs.curses.evenCursed && len % 2 === 0) return 0;

    let letterSum = 0;
    selected.forEach((tile, idx) => {
        const letter = effectiveLetter(tile);
        let val = LETTER_VALUES[letter] || 1;
        if (gs.upgrades.valueBoost && val === 1) val = 2;
        const lotd = gs.levelBonuses.letterOfDay.find(l => l.letter === letter);
        if (lotd) val *= 3;
        if (gs.curses.vocalsCursed && VOWELS.has(letter)) val = 0;
        if (gs.curses.cursedLetters.includes(letter)) val = 0;
        if (gs.curses.burnedIds.includes(tile.id)) val = 0;
        if (gs.upgrades.posDouble.includes(idx)) val *= 2;
        if (idx >= 6 && gs.upgrades.posFrom7) val *= 2;
        letterSum += val;
    });

    const { mult, bonus } = getWordScore(len);
    return Math.max(0, Math.round(letterSum * mult) + bonus);
}

function getScoreDetail(selected) {
    const gs = gameState;
    const len = selected.length;

    if (gs.curses.onlyShort && len > 4) return { pts: 0, detail: '‚úó maldici√≥n', mult: 0, bonus: 0 };
    if (gs.curses.shortWordsCursed && len <= 4) return { pts: 0, detail: '‚úó maldici√≥n', mult: 0, bonus: 0 };
    if (gs.curses.oddCursed && len % 2 !== 0) return { pts: 0, detail: '‚úó maldici√≥n', mult: 0, bonus: 0 };
    if (gs.curses.evenCursed && len % 2 === 0) return { pts: 0, detail: '‚úó maldici√≥n', mult: 0, bonus: 0 };

    let letterSum = 0;
    selected.forEach((tile, idx) => {
        const letter = effectiveLetter(tile);
        let val = LETTER_VALUES[letter] || 1;
        if (gs.upgrades.valueBoost && val === 1) val = 2;
        const lotd = gs.levelBonuses.letterOfDay.find(l => l.letter === letter);
        if (lotd) val *= 3;
        if (gs.curses.vocalsCursed && VOWELS.has(letter)) val = 0;
        if (gs.curses.cursedLetters.includes(letter)) val = 0;
        if (gs.curses.burnedIds.includes(tile.id)) val = 0;
        if (gs.upgrades.posDouble.includes(idx)) val *= 2;
        if (idx >= 6 && gs.upgrades.posFrom7) val *= 2;
        letterSum += val;
    });

    const { mult, bonus } = getWordScore(len);
    const pts = Math.max(0, Math.round(letterSum * mult) + bonus);
    const wLvl = gs.upgrades.wordLevels[lenIdx(len)] + 1;
    const multStr = mult !== 1 ? `√ó${mult}` : '';
    const bonusStr = bonus > 0 ? `+${bonus}` : '';
    const detail = `Nv${wLvl} ${letterSum}pts ${multStr}${bonusStr ? ' ' + bonusStr : ''}`.trim();

    return { pts, detail, mult, bonus };
}

// ============================================================
//  RENDER
// ============================================================
function renderAll() {
    renderHUD();
    renderHand();
    renderWordDisplay();
}

function renderHUD() {
    const gs = gameState;
    document.getElementById('hud-score').textContent = gs.score;
    document.getElementById('hud-attempts').textContent = gs.jugadasLeft;
    document.getElementById('hud-coins').textContent = gs.coins;
    document.getElementById('hud-prog-cur').textContent = gs.score;
    document.getElementById('hud-prog-goal').textContent = gs.goal;
    const pct = Math.min(100, (gs.score / gs.goal) * 100);
    document.getElementById('hud-bar').style.width = pct + '%';
    const roundLabel = gs.isBoss
        ? `Nivel ${gs.level} ¬∑ ‚öî Jefe`
        : `Nivel ${gs.level} ¬∑ Ronda ${gs.round}/${CONFIG.MAX_ROUNDS}`;
    document.getElementById('hud-round').textContent = roundLabel;
    document.getElementById('boss-row').style.display = gs.isBoss ? 'flex' : 'none';
}

function renderHand() {
    const gs = gameState;
    const handEl = document.getElementById('hand');
    handEl.innerHTML = '';

    gs.hand.forEach(tile => {
        const div = document.createElement('div');
        div.className = 'tile';
        if (!tile.letter) {
            div.classList.add('empty');
        } else {
            const isWild = tile.letter === '*';
            const isBurned = gs.curses.burnedIds.includes(tile.id);
            const isCursedLetter = gs.curses.cursedLetters.includes(effectiveLetter(tile));
            const displayLetter = isWild ? (tile.chosenLetter || '‚ú¶') : tile.letter;
            const displayVal = isWild
                ? (tile.chosenLetter ? LETTER_VALUES[tile.chosenLetter] || 1 : '?')
                : (LETTER_VALUES[tile.letter] || 1);

            div.textContent = displayLetter;
            if (isWild) div.classList.add('wildcard');
            if (isBurned) div.classList.add('burned');
            if (isCursedLetter) div.classList.add('cursed-tile');

            // Marca letra del d√≠a
            const lotd = gs.levelBonuses.letterOfDay.find(l => l.letter === displayLetter);
            if (lotd) div.classList.add('letter-day');

            const val = document.createElement('div');
            val.className = 'tile-val';
            val.textContent = isBurned || (isCursedLetter && !isWild) ? 'üî•' : displayVal;
            div.appendChild(val);

            if (cincelMode && !isWild) {
                div.classList.add('cincel-ready');
                div.onclick = () => openPicker(tile.id, true);
            } else if (gs.discardMode) {
                div.classList.add('discarding');
                if (gs.selectedIds.includes(tile.id)) div.style.opacity = '0.4';
                div.onclick = () => toggleDiscardSelect(tile.id);
            } else {
                if (gs.selectedIds.includes(tile.id)) div.classList.add('selected');
                div.onclick = () => {
                    if (isWild && !tile.chosenLetter) openPicker(tile.id);
                    else toggleSelect(tile.id);
                };
            }
        }
        handEl.appendChild(div);
    });

    // Bolsa
    document.getElementById('bag-info').textContent =
        gs.bag.length > 0 ? `BOLSA: ${gs.bag.length} letras` : 'BOLSA VAC√çA';

    // Bot√≥n descarte
    const discardBtn = document.getElementById('btn-discard');
    const discardCount = document.getElementById('discard-count');
    const noDisc = gs.curses.noDiscards;
    discardBtn.disabled = gs.discardsLeft <= 0 || noDisc;
    discardBtn.classList.toggle('active', gs.discardMode);
    discardCount.textContent = noDisc ? '(maldito)' : `(${gs.discardsLeft} restantes)`;

    // Bot√≥n cincel
    const cincelBtn = document.getElementById('btn-cincel');
    if (cincelBtn) {
        cincelBtn.style.display = gs.upgrades.cincelUses > 0 ? 'inline-flex' : 'none';
        cincelBtn.classList.toggle('active', cincelMode);
        cincelBtn.textContent = `üî® Cincel (${gs.upgrades.cincelUses})`;
    }

    document.getElementById('discard-hint').classList.toggle('visible', gs.discardMode);
    document.getElementById('cincel-hint').classList.toggle('visible', cincelMode);
}

function renderWordDisplay() {
    const gs = gameState;
    const el = document.getElementById('word-display');
    const selected = gs.selectedIds.map(id => gs.hand.find(t => t.id === id)).filter(Boolean);

    if (selected.length === 0) {
        el.innerHTML = '<div class="word-placeholder">selecciona letras de tu mano</div>';
    } else {
        el.innerHTML = '';
        selected.forEach((tile, idx) => {
            const div = document.createElement('div');
            div.className = 'word-letter';
            const eff = effectiveLetter(tile);
            div.textContent = eff;
            if (tile.letter === '*') div.style.color = '#a78bfa';
            if (gs.curses.burnedIds.includes(tile.id)) div.style.opacity = '0.4';
            if (gs.curses.cursedLetters.includes(eff)) div.style.textDecoration = 'line-through';
            // Position highlight
            if (gs.upgrades.posDouble.includes(idx)) div.classList.add('pos-boosted');
            if (idx >= 6 && gs.upgrades.posFrom7) div.classList.add('pos-boosted');
            const val = document.createElement('div');
            val.className = 'letter-val';
            val.textContent = LETTER_VALUES[eff] || 1;
            div.appendChild(val);
            el.appendChild(div);
        });
    }

    const previewEl = document.getElementById('word-score-preview');
    if (selected.length >= 1) {
        const { pts, detail, mult, bonus } = getScoreDetail(selected);
        let html = `${pts} pts <span class="preview-detail">(${detail})</span>`;
        previewEl.innerHTML = html;
    } else {
        previewEl.innerHTML = '';
    }

    const hasWord = selected.length >= 2;
    document.getElementById('btn-play').disabled = !hasWord;
    document.getElementById('btn-clear').disabled = selected.length === 0;
}

function renderCurseBar() {
    const gs = gameState;
    const bar = document.getElementById('curse-bar');
    if (!bar) return;
    bar.innerHTML = '';
    if (!gs.isBoss || gs.curses.active.length === 0) return;
    gs.curses.active.forEach(id => {
        const curse = BOSS_CURSES.find(c => c.id === id);
        if (!curse) return;
        const span = document.createElement('span');
        span.className = 'curse-tag';
        let name = curse.name;
        if (id === 'letters_cursed' && gs.curses.cursedLetters.length > 0) {
            name += `: ${gs.curses.cursedLetters.join(', ')}`;
        }
        span.textContent = `${curse.emoji} ${name}`;
        bar.appendChild(span);
    });
}

function renderBuffBar() {
    const gs = gameState;
    const bar = document.getElementById('buff-bar');
    if (!bar) return;
    const buffs = [];
    if (gs.upgrades.valueBoost) buffs.push('‚¨ÜÔ∏è Valor+1');
    if (gs.upgrades.handBonus > 0) buffs.push(`‚úã+${gs.upgrades.handBonus}`);
    if (gs.upgrades.posFrom7) buffs.push('‚ë¶√ó2');
    gs.upgrades.posDouble.forEach(p => buffs.push(`√ó2pos${p+1}`));
    if (gs.upgrades.discardEconomy) buffs.push('üíéEcoDesc');
    if (gs.upgrades.playEconomy) buffs.push('üíéEcoJug');
    gs.levelBonuses.letterOfDay.forEach(l => buffs.push(`‚≠ê${l.letter}√ó3`));
    if (gs.levelBonuses.extraJugadas > 0) buffs.push(`üÉè+${gs.levelBonuses.extraJugadas}jug`);
    if (gs.upgrades.extraDiscards > 0) buffs.push(`‚ôªÔ∏è+${gs.upgrades.extraDiscards}`);
    // Niveles de palabra
    gs.upgrades.wordLevels.forEach((lvl, i) => {
        if (lvl > 0) {
            const { mult, bonus } = WORD_LEVEL_TABLE[i][lvl];
            buffs.push(`${WORD_LENGTH_EMOJIS[i]}Nv${lvl+1} √ó${mult}+${bonus}`);
        }
    });

    if (buffs.length === 0) {
        bar.style.display = 'none';
    } else {
        bar.style.display = 'flex';
        bar.innerHTML = buffs.map(b => `<span class="buff-tag">${b}</span>`).join('');
    }
}

// ============================================================
//  SELECCI√ìN
// ============================================================
function toggleSelect(id) {
    if (gameState.discardMode || cincelMode) return;
    const idx = gameState.selectedIds.indexOf(id);
    if (idx === -1) {
        gameState.selectedIds.push(id);
    } else {
        gameState.selectedIds.splice(idx, 1);
        // Si era un comod√≠n, resetear la letra elegida al devolverlo a la mano
        const tile = gameState.hand.find(t => t.id === id);
        if (tile && tile.letter === '*') tile.chosenLetter = null;
    }
    renderWordDisplay();
    renderHand();
}

function toggleDiscardSelect(id) {
    const idx = gameState.selectedIds.indexOf(id);
    if (idx === -1) gameState.selectedIds.push(id);
    else gameState.selectedIds.splice(idx, 1);
    renderHand();
}

function clearWord() {
    // Resetear letra elegida en comodines que estaban seleccionados
    gameState.selectedIds.forEach(id => {
        const tile = gameState.hand.find(t => t.id === id);
        if (tile && tile.letter === '*') tile.chosenLetter = null;
    });
    gameState.selectedIds = [];
    renderWordDisplay();
    renderHand();
    setFeedback('', '');
}

// ============================================================
//  CINCEL
// ============================================================
function toggleCincelMode() {
    const gs = gameState;
    if (gs.upgrades.cincelUses <= 0) return;
    cincelMode = !cincelMode;
    if (cincelMode) {
        gs.selectedIds = [];
        gs.discardMode = false;
    }
    renderHand();
    renderWordDisplay();
    document.getElementById('cincel-hint').classList.toggle('visible', cincelMode);
}

// ============================================================
//  DESCARTAR
// ============================================================
function toggleDiscardMode() {
    const gs = gameState;
    if (gs.discardsLeft <= 0 || gs.curses.noDiscards) return;
    gs.discardMode = !gs.discardMode;
    gs.selectedIds = [];
    cincelMode = false;
    renderHand();
    renderWordDisplay();
    if (gs.discardMode) {
        document.getElementById('btn-discard').onclick = confirmDiscard;
        document.getElementById('btn-discard').textContent = '‚úì Confirmar';
    } else {
        document.getElementById('btn-discard').onclick = toggleDiscardMode;
        document.getElementById('btn-discard').textContent = '‚úï Descartar';
    }
}

function confirmDiscard() {
    const gs = gameState;
    const toDiscard = [...gs.selectedIds];
    if (toDiscard.length === 0) {
        gs.discardMode = false;
        document.getElementById('btn-discard').onclick = toggleDiscardMode;
        document.getElementById('btn-discard').textContent = '‚úï Descartar';
        renderHand();
        return;
    }
    toDiscard.forEach(id => {
        const tile = gs.hand.find(t => t.id === id);
        if (tile) { tile.letter = null; tile.chosenLetter = null; }
    });
    gs.discardsLeft--;
    gs.selectedIds = [];
    gs.discardMode = false;
    document.getElementById('btn-discard').onclick = toggleDiscardMode;
    document.getElementById('btn-discard').textContent = '‚úï Descartar';
    fillHand();
    addLog(`Descarte (${gs.discardsLeft} restantes)`, 'sys');
    renderAll();
}

// ============================================================
//  REVOLVER
// ============================================================
function shuffleHand() {
    const gs = gameState;
    const letters = gs.hand.map(t => ({ letter: t.letter, chosen: t.chosenLetter }));
    const shuffled = shuffleArr(letters);
    gs.hand.forEach((t, i) => { t.letter = shuffled[i].letter; t.chosenLetter = shuffled[i].chosen; });
    gs.selectedIds = [];
    renderHand();
    renderWordDisplay();
}

// ============================================================
//  JUGAR PALABRA
// ============================================================
function playWord() {
    const gs = gameState;
    const selected = gs.selectedIds.map(id => gs.hand.find(t => t.id === id)).filter(Boolean);
    if (selected.length < 2) return;

    const unresolved = selected.find(t => t.letter === '*' && !t.chosenLetter);
    if (unresolved) { setFeedback('Elige una letra para el comod√≠n ‚ú¶', 'err'); return; }

    const word = selected.map(t => effectiveLetter(t)).join('');

    if (!isValidWord(word)) {
        setFeedback(`"${word}" no es v√°lida`, 'err');
        clearWord();
        return;
    }

    const points = calculatePoints(selected);

    gs.score += points;
    gs.totalScore += points;
    gs.totalWords++;
    gs.jugadasLeft--;

    // Quitar fichas usadas
    gs.selectedIds.forEach(id => {
        const tile = gs.hand.find(t => t.id === id);
        if (tile) { tile.letter = null; tile.chosenLetter = null; }
    });
    gs.selectedIds = [];
    fillHand();

    // Actualizar fichas quemadas tras jugar (Mano Quemada)
    if (gs.curses.burnedIds.length > 0) {
        refreshBurnedTiles(gs);
    }

    setFeedback(`+${points} pts`, 'ok');
    addLog(word, 'ok', points);
    showScorePop(`+${points}`);
    renderAll();
    renderCurseBar();

    if (gs.score >= gs.goal) { setTimeout(roundWin, 600); return; }
    if (gs.jugadasLeft <= 0) { setTimeout(gameOver, 500); return; }

    // Game over si bolsa vac√≠a Y mano vac√≠a
    const hasLetters = gs.hand.some(t => t.letter !== null);
    if (!hasLetters) { setTimeout(gameOver, 500); return; }
}

// ============================================================
//  ROUND WIN / PROGRESSION
// ============================================================
function roundWin() {
    const gs = gameState;

    // Calcular monedas
    const baseCoins = 2;
    const discardCoins = gs.upgrades.discardEconomy ? gs.discardsLeft * 2 : 0;
    const playMult = gs.upgrades.playEconomy ? 2 : 1;
    const playCoins = gs.jugadasLeft * 1 * playMult;
    const totalCoins = baseCoins + discardCoins + playCoins;
    gs.coins += totalCoins;

    const isBossWin = gs.isBoss;
    document.getElementById('rw-title').textContent = isBossWin ? '‚öî ¬°Jefe Derrotado!' : '‚ú® ¬°Ronda Superada!';
    document.getElementById('rw-sub').textContent = `${gs.score} / ${gs.goal} pts`;
    document.getElementById('rw-score').textContent = gs.score;

    // Desglose monedas
    let coinsHTML = `<div class="coin-row"><span>Base</span><span>+${baseCoins} ü™ô</span></div>`;
    if (discardCoins > 0) coinsHTML += `<div class="coin-row"><span>Descartes sin usar (√ó2)</span><span>+${discardCoins} ü™ô</span></div>`;
    if (playCoins > 0) coinsHTML += `<div class="coin-row"><span>Jugadas sin usar${gs.upgrades.playEconomy ? ' (√ó2)' : ''}</span><span>+${playCoins} ü™ô</span></div>`;
    coinsHTML += `<div class="coin-row total"><span>Total</span><span>+${totalCoins} ü™ô</span></div>`;
    document.getElementById('rw-coins').innerHTML = coinsHTML;

    showModal('round-win');
}

function goToShop() {
    const gs = gameState;
    hideAllModals();

    const wasBoss = gs.isBoss;
    if (wasBoss) {
        // Nuevo nivel: resetear bonuses de nivel
        gs.levelBonuses.letterOfDay = [];
        gs.levelBonuses.extraJugadas = 0;
        gs.level++;
        gs.round = 1;
        if (gs.level > CONFIG.MAX_LEVELS) { victory(); return; }
    } else {
        gs.round++;
    }

    gs.shopVisits++;
    const shopSlots = gs.upgrades.shopSize ? 4 : 3;

    // Separar mejoras normales de mejoras de palabra
    const normalItems = SHOP_ITEMS.filter(item => {
        if (!item.canBuy(gs)) return false;
        // Tama√±o de tienda no aparece en las 2 primeras visitas
        if (item.id === 'shop_size' && gs.shopVisits <= 2) return false;
        return true;
    });
    const wordItems = getWordUpgradeItems();

    // Selecci√≥n: primero elegir si habr√° 1 mejora de palabra (50% si hay disponibles)
    const selection = [];
    const pool = [...normalItems];

    // A√±adir exactamente 1 mejora de palabra (si hay y hay hueco)
    if (wordItems.length > 0 && Math.random() < 0.6) {
        const wordItem = weightedRandom(wordItems, i => i.weight);
        selection.push(wordItem);
    }

    // Rellenar el resto con mejoras normales
    while (selection.length < shopSlots && pool.length > 0) {
        const item = weightedRandom(pool, i => i.weight);
        selection.push(item);
        pool.splice(pool.indexOf(item), 1);
    }

    // Mezclar para que la mejora de palabra no siempre salga primera
    for (let i = selection.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [selection[i], selection[j]] = [selection[j], selection[i]];
    }

    gs.shopSelection = selection;
    gs.shopBoughtIds = [];

    const nextLabel = gs.round > CONFIG.MAX_ROUNDS
        ? `Siguiente: Nivel ${gs.level} ¬∑ ‚öî Jefe`
        : `Siguiente: Nivel ${gs.level} ¬∑ Ronda ${gs.round}/${CONFIG.MAX_ROUNDS}`;
    document.getElementById('shop-sub').textContent = nextLabel;
    document.getElementById('shop-coins').textContent = `${gs.coins} ü™ô`;

    renderShop();
    showModal('shop');
}

function renderShop() {
    const gs = gameState;
    const grid = document.getElementById('shop-grid');
    grid.innerHTML = '';
    const items = gs.shopSelection || [];
    items.forEach(item => {
        const alreadyBought = gs.shopBoughtIds.includes(item.id);
        const canAfford = gs.coins >= item.price;
        const canBuy = item.canBuy(gs);
        const disabled = alreadyBought || !canAfford || !canBuy;

        // Descripci√≥n m√°s clara para mejoras de palabra
        let desc = item.desc;
        if (item.isWordUpgrade) {
            const idx = item.lenIdx;
            const curLvl = gs.upgrades.wordLevels[idx];
            const cur = WORD_LEVEL_TABLE[idx][curLvl];
            const nxt = WORD_LEVEL_TABLE[idx][curLvl + 1];
            desc = `Ahora: √ó${cur.mult} +${cur.bonus} de bonus<br>` +
                   `Despu√©s: √ó${nxt.mult} +${nxt.bonus} de bonus`;
        }

        const div = document.createElement('div');
        let cls = 'shop-item';
        if (alreadyBought) cls += ' already-bought';
        else if (!canAfford || !canBuy) cls += ' cant-afford';
        div.className = cls;

        const isBracketIcon = /^\[.+\]$/.test(item.emoji);
        const iconClass = isBracketIcon ? 'shop-item-icon' : 'shop-item-icon emoji-icon';

        div.innerHTML = `
            <div class="${iconClass}">${item.emoji}</div>
            <div class="shop-item-body">
                <div class="shop-item-name">${item.name}${alreadyBought ? ' ‚úì' : ''}</div>
                <div class="shop-item-desc">${desc.replace(/\n/g, '<br>')}</div>
            </div>
            <div class="shop-item-price">${item.price}ü™ô</div>
        `;

        if (!disabled) div.onclick = () => buyItem(item);
        grid.appendChild(div);
    });
    document.getElementById('shop-coins').textContent = `${gs.coins} ü™ô`;
}

function buyItem(item) {
    const gs = gameState;
    if (gs.coins < item.price || !item.canBuy(gs)) return;
    if (gs.shopBoughtIds.includes(item.id)) return;
    gs.coins -= item.price;
    gs.shopBoughtIds.push(item.id);
    item.apply(gs);
    addLog(`Comprado: ${item.name}`, 'sys');
    renderShop();
    renderBuffBar();
}

function nextRound() {
    hideAllModals();
    initRound();
}

// ============================================================
//  BOSS INTRO
// ============================================================
function showBossIntro() {
    const gs = gameState;
    const curseList = document.getElementById('boss-curse-list');
    curseList.innerHTML = '';
    gs.curses.active.forEach(id => {
        const curse = BOSS_CURSES.find(c => c.id === id);
        if (!curse) return;
        let name = curse.name;
        if (id === 'letters_cursed' && gs.curses.cursedLetters.length > 0) {
            name += `: ${gs.curses.cursedLetters.join(', ')}`;
        }
        curseList.innerHTML += `
            <div class="boss-curse-item">
                <span class="boss-curse-emoji">${curse.emoji}</span>
                <div>
                    <div class="boss-curse-name">${name}</div>
                    <div class="boss-curse-desc">${curse.desc}</div>
                </div>
            </div>`;
    });
    document.getElementById('boss-intro-level').textContent = `Nivel ${gs.level} ¬∑ Objetivo: ${gs.goal} pts`;
    showModal('boss-intro');
}

function startBossFight() {
    hideAllModals();
    addLog(`‚öî JEFE ‚Äî Objetivo: ${gameState.goal} pts`, 'sys');
}

// ============================================================
//  GAME OVER / VICTORY
// ============================================================
function gameOver() {
    const gs = gameState;
    const stats = document.getElementById('gameover-stats');
    stats.innerHTML = `
        <div class="result-stat-row"><span>Nivel alcanzado</span><span>${gs.level}</span></div>
        <div class="result-stat-row"><span>Ronda</span><span>${gs.round}</span></div>
        <div class="result-stat-row"><span>Palabras jugadas</span><span>${gs.totalWords}</span></div>
        <div class="result-stat-row"><span>Puntos totales</span><span>${gs.totalScore}</span></div>
    `;
    showModal('gameover');
}

function victory() {
    const gs = gameState;
    const stats = document.getElementById('victory-stats');
    stats.innerHTML = `
        <div class="result-stat-row"><span>Palabras jugadas</span><span>${gs.totalWords}</span></div>
        <div class="result-stat-row"><span>Puntos totales</span><span>${gs.totalScore}</span></div>
        <div class="result-stat-row"><span>Monedas restantes</span><span>${gs.coins} ü™ô</span></div>
    `;
    showModal('victory');
}

// ============================================================
//  UI HELPERS
// ============================================================
function setFeedback(msg, type) {
    const el = document.getElementById('feedback');
    el.textContent = msg;
    el.className = 'feedback ' + type;
}

function addLog(msg, type, pts) {
    const log = document.getElementById('log');
    const entry = document.createElement('div');
    entry.className = 'log-entry ' + type;
    if (type === 'sys') {
        entry.innerHTML = `<span>‚Äî ${msg}</span>`;
    } else {
        entry.innerHTML = `<span class="log-word">${msg}</span>${pts !== undefined ? `<span class="log-pts">+${pts} pts</span>` : ''}`;
    }
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
}

function showScorePop(text) {
    const pop = document.createElement('div');
    pop.className = 'score-pop';
    pop.textContent = text;
    const wa = document.querySelector('.word-area');
    const rect = wa.getBoundingClientRect();
    pop.style.left = (rect.left + rect.width / 2 - 30) + 'px';
    pop.style.top = (rect.top - 10 + window.scrollY) + 'px';
    document.body.appendChild(pop);
    setTimeout(() => pop.remove(), 1300);
}

function showModal(name) { document.getElementById('modal-' + name).classList.add('active'); }
function hideAllModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); }

// ============================================================
//  EXIT / SAVE SEED
// ============================================================
function showExitModal() {
    document.getElementById('save-seed-area').style.display = 'none';
    showModal('exit');
}

function confirmSurrender() {
    hideAllModals();
    resetGame();
}

function showSaveSeed() {
    const seed = generateSeed();
    document.getElementById('seed-display').textContent = seed;
    document.getElementById('save-seed-area').style.display = 'block';
}

function copySeed() {
    const seed = document.getElementById('seed-display').textContent;
    navigator.clipboard.writeText(seed).then(() => {
        const btn = document.querySelector('#save-seed-area button');
        btn.textContent = '‚úì Copiado!';
        setTimeout(() => btn.textContent = 'üìã Copiar c√≥digo', 2000);
    }).catch(() => {
        // fallback: select text
        const el = document.getElementById('seed-display');
        const range = document.createRange();
        range.selectNode(el);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
    });
}

function generateSeed() {
    const gs = gameState;
    const data = {
        v: 1, // version
        level: gs.level,
        round: gs.round,
        coins: gs.coins,
        score: gs.totalScore,
        words: gs.totalWords,
        upgrades: gs.upgrades,
        levelBonuses: gs.levelBonuses,
        shopVisits: gs.shopVisits,
    };
    return btoa(JSON.stringify(data)).replace(/=/g, '').substring(0, 40).toUpperCase();
}

function loadSeed(seed) {
    try {
        // Pad base64 if needed
        const padded = seed + '=='.slice(0, (4 - seed.length % 4) % 4);
        const data = JSON.parse(atob(padded));
        if (!data.v) throw new Error('invalid');
        gameState = freshState();
        gameState.level = data.level || 1;
        gameState.round = data.round || 1;
        gameState.coins = data.coins || 0;
        gameState.totalScore = data.score || 0;
        gameState.totalWords = data.words || 0;
        gameState.upgrades = { ...freshState().upgrades, ...data.upgrades };
        gameState.levelBonuses = { ...freshState().levelBonuses, ...data.levelBonuses };
        gameState.shopVisits = data.shopVisits || 0;
        initRound();
        showScreen('game');
        addLog('‚ö° Partida cargada desde c√≥digo', 'sys');
        return true;
    } catch(e) {
        return false;
    }
}

window.addEventListener('load', () => { loadDictionary(); });
</script>
</body>
</html>
